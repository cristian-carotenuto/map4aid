name: Converti Documenti DOCX in MD

on:
  push:
    branches:
      - main
    paths:
      - '**.docx'

jobs:
  convert-docs:
    permissions:
      contents: write 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Trova e converti i file DOCX
        run: |
          # Trova tutti i file .docx
          find . -type f -name "*.docx" | while read docx_file; do
            filename=$(basename "$docx_file")
            
            # CONTROLLO DI SICUREZZA: Salta i file che iniziano con ~$
            if [[ "$filename" == "~$"* ]]; then
              echo "Salto file temporaneo: $docx_file"
              continue
            fi

            md_file="${docx_file%.docx}.md"
            echo "Convertendo $docx_file in $md_file..."
            
            # Esegue la conversione
            pandoc "$docx_file" -f docx -t gfm --wrap=none -s -o "$md_file"
          done

      - name: Commit dei file Markdown
        run: |
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'github-actions-bot@github.com'
          
          # CORREZIONE: Aggiunge tutti i file .md, anche nelle sottocartelle
          git add "**/*.md"
          
          if ! git diff --cached --quiet; then
            git commit -m "Azione: Convertito automaticamente DOCX in Markdown"
            git push
          else
            echo "Nessun file .md modificato. Nessun commit necessario."
          fi
