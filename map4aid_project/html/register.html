<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Registrazione - Map4Aid</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-light">
  <!-- Header dinamico -->
  <header class="header-bg text-white p-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <img src="{{ url_for('static', filename='imgs/logo.png') }}" alt="Logo Map4Aid" width="60" height="60" class="me-3 rounded-circle">
      <h1 class="h4 mb-0 ms-3">MAP4AID</h1>
    </div>
    <div class="d-flex gap-2" id="auth-buttons"></div>
  </header>
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="text-center">Crea il tuo account</h3>
          </div>
          <div class="card-body">
            <form id="registerForm" enctype="multipart/form-data">
              <div class="mb-3">
                <label for="user" class="form-label">Seleziona il tipo di account</label>
                <select class="form-select" id="user" name="ruolo" required>
                  <option value="">Seleziona il tipo di account che vuoi creare</option>
                  <option value="beneficiario">Utente Beneficiario</option>
                  <option value="donatore">Utente Donatore</option>
                  <option value="erogatore">Ente Erogatore</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" required>
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" name="password" required>
              </div>
              <div id="campiBeneficiario" style="display:none;">
                <div class="mb-3"><label for="nome" class="form-label">Nome</label><input type="text" class="form-control" id="nome" name="nome"></div>
                <div class="mb-3"><label for="cognome" class="form-label">Cognome</label><input type="text" class="form-control" id="cognome" name="cognome"></div>
                <div class="mb-3"><label for="data_nascita" class="form-label">Data di nascita</label><input type="date" class="form-control" id="data_nascita" name="data_nascita"></div>
                <div class="mb-3"><label for="codice_carta_identita" class="form-label">Codice Carta d'Identità</label><input type="text" class="form-control" id="codice_carta_identita" name="codice_carta_identita" placeholder="Es. CA00000AA"></div>
                <div class="mb-3"><label for="carta_identita" class="form-label">Immagine Carta d'Identità</label><input type="file" class="form-control" id="carta_identita" name="carta_identita" accept="image/*,.pdf"></div>
                <div class="mb-3"><label for="allergeni" class="form-label">Allergeni</label><input type="text" class="form-control" id="allergeni" name="allergeni" placeholder="Es. Glutine, Lattosio..."></div>
                <div class="mb-3"><label for="patologie" class="form-label">Patologie</label><input type="text" class="form-control" id="patologie" name="patologie" placeholder="Es. Diabete, Celiachia..."></div>
              </div>
              <div id="campiDonatore" style="display:none;">
                <div class="mb-3"><label for="nome_don" class="form-label">Nome</label><input type="text" class="form-control" id="nome_don" name="nome"></div>
                <div class="mb-3"><label for="cognome_don" class="form-label">Cognome</label><input type="text" class="form-control" id="cognome_don" name="cognome"></div>
                <div class="mb-3"><label for="partita_iva" class="form-label">Partita IVA</label><input type="text" class="form-control" id="partita_iva" name="partita_iva"></div>
                <div class="mb-3"><label for="categoria" class="form-label">Categoria</label><input type="text" class="form-control" id="categoria" name="categoria"></div>
                <div class="mb-3"><label for="nome_attivita" class="form-label">Nome Attività</label><input type="text" class="form-control" id="nome_attivita" name="nome_attivita"></div>
                <div class="mb-3"><label for="indirizzo_sede" class="form-label">Indirizzo Sede</label><input type="text" class="form-control" id="indirizzo_sede" name="indirizzo_sede"></div>
              </div>
              <div id="campiErogatore" style="display:none;">
                <div class="mb-3"><label for="nome_organizzazione" class="form-label">Nome Organizzazione</label><input type="text" class="form-control" id="nome_organizzazione" name="nome_organizzazione"></div>
                <div class="mb-3"><label for="indirizzo_sede_erog" class="form-label">Indirizzo Sede</label><input type="text" class="form-control" id="indirizzo_sede_erog" name="indirizzo_sede"></div>
                <div class="mb-3"><label for="tipologia_ente" class="form-label">Tipologia Ente</label><input type="text" class="form-control" id="tipologia_ente" name="tipologia_ente"></div>
                <div class="mb-3"><label for="iban" class="form-label">IBAN</label><input type="text" class="form-control" id="iban" name="iban"></div>
              </div>
              <button type="submit" class="btn btn-success w-100">Registrati</button>
            </form>
            <div id="errorMessage" class="mt-3 text-danger" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="codiceModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Conferma la registrazione</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Inserisci il codice a 4 cifre inviato alla tua email.</p>
          <form id="codiceForm">
            <div class="mb-3">
              <label for="codice" class="form-label">Codice</label>
              <input type="text" class="form-control" id="codice" name="codice" maxlength="4" required>
            </div>
            <div id="codiceError" class="text-danger" style="display:none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="confermaCodiceBtn">Conferma</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-3 mt-4">
    <p>&copy; 2026 Map4Aid - Progetto Universitario</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
  <script>
    /**
     * mostra/nascondi i campi specifici in base al ruolo selezionato
     */
    selectRole();
    document.getElementById("user").addEventListener("change", selectRole);
    function selectRole()
    {
      let user = document.getElementById("user").value;

      if (user === 'beneficiario') {
        document.getElementById('campiBeneficiario').style.display = 'block';
        document.getElementById('campiDonatore').style.display = 'none';
        document.getElementById('campiErogatore').style.display = 'none';
      } else if (user === 'donatore') {
        document.getElementById('campiBeneficiario').style.display = 'none';
        document.getElementById('campiDonatore').style.display = 'block';
        document.getElementById('campiErogatore').style.display = 'none';
      } else if (user === 'erogatore') {
        document.getElementById('campiBeneficiario').style.display = 'none';
        document.getElementById('campiDonatore').style.display = 'none';
        document.getElementById('campiErogatore').style.display = 'block';
      } else {
        document.getElementById('campiBeneficiario').style.display = 'none';
        document.getElementById('campiDonatore').style.display = 'none';
        document.getElementById('campiErogatore').style.display = 'none';
      }
    }

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const ruolo = document.getElementById('user').value;
      if (!email || !password || !ruolo) { showError('errorMessage', 'Compila tutti i campi obbligatori'); return; }

      const formData = new FormData();
      formData.append('email', email);
      formData.append('password', password);
      formData.append('ruolo', ruolo);

      // Aggiungi i campi specifici per ruolo
      if (ruolo === 'beneficiario') {
        formData.append('nome', document.getElementById('nome').value);
        formData.append('cognome', document.getElementById('cognome').value);
        formData.append('data_nascita', document.getElementById('data_nascita').value);
        formData.append('codice_carta_identita', document.getElementById('codice_carta_identita').value);
        formData.append('allergeni', document.getElementById('allergeni').value);
        formData.append('patologie', document.getElementById('patologie').value);
        const fileCi = document.getElementById('carta_identita').files[0];
        if (fileCi) {
          formData.append('carta_identita', fileCi);
        }
      } else if (ruolo === 'donatore') {
        formData.append('nome', document.getElementById('nome_don').value);
        formData.append('cognome', document.getElementById('cognome_don').value);
        formData.append('partita_iva', document.getElementById('partita_iva').value);
        formData.append('categoria', document.getElementById('categoria').value);
        formData.append('nome_attivita', document.getElementById('nome_attivita').value);
        formData.append('indirizzo_sede', document.getElementById('indirizzo_sede').value);
      } else if (ruolo === 'erogatore') {
        formData.append('nome_organizzazione', document.getElementById('nome_organizzazione').value);
        formData.append('indirizzo_sede', document.getElementById('indirizzo_sede_erog').value);
        formData.append('tipologia_ente', document.getElementById('tipologia_ente').value);
        formData.append('iban', document.getElementById('iban').value);
      }

      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true; submitBtn.textContent = 'Invio in corso...';
      try {
        const response = await fetch('/auth/register', { method: 'POST', body: formData });
        const data = await response.json();
        if (response.ok) {
          localStorage.setItem('ruoloRegistrazione', ruolo);
          localStorage.setItem('emailRegistrazione', email);
          new bootstrap.Modal(document.getElementById('codiceModal')).show();
        } else { showError('errorMessage', data.error || 'Errore sconosciuto durante la registrazione'); }
      } catch (error) { showError('errorMessage', 'Errore di connessione al server'); }
      finally { submitBtn.disabled = false; submitBtn.textContent = originalText; }
    });

    document.getElementById('confermaCodiceBtn').addEventListener('click', async () => {
      const codice = document.getElementById('codice').value;
      if (!codice) { showError('codiceError', 'Inserisci il codice ricevuto via email'); return; }
      const submitBtn = document.getElementById('confermaCodiceBtn');
      submitBtn.disabled = true; submitBtn.textContent = 'Verifica in corso...';
      try {
        const formData = new FormData(); formData.append('codice', codice);
        const response = await fetch('/auth/2FARegister', { method: 'POST', body: formData });
        const data = await response.json();
        if (response.ok) {
          bootstrap.Modal.getInstance(document.getElementById('codiceModal')).hide();
          alert('Registrazione completata con successo!');
          window.location.href = '/login';
        } else { showError('codiceError', data.error || 'Codice non valido o scaduto'); }
      } catch (error) { showError('codiceError', 'Errore di connessione durante la verifica'); }
      finally { submitBtn.disabled = false; submitBtn.textContent = 'Conferma'; }
    });
  </script>
  <script src="../chatbot/js/loader.js"></script>
</body>
</html>
