<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>Cambio Password - Map4Aid</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .strength-weak {
            background-color: #dc3545;
            width: 33%;
        }

        .strength-medium {
            background-color: #ffc107;
            width: 66%;
        }

        .strength-strong {
            background-color: #28a745;
            width: 100%;
        }

        .password-toggle {
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .password-input-wrapper {
            position: relative;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-center">Imposta Nuova Password</h3>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Scegli una password sicura per il tuo account.</p>

                        <!-- Form per cambio password -->
                        <form id="cambioPasswordForm">
                            <div class="mb-3">
                                <label for="nuova_password" class="form-label">Nuova Password</label>
                                <div class="password-input-wrapper">
                                    <input type="password" class="form-control" id="nuova_password"
                                        name="nuova_password" required>
                                    <span class="password-toggle" id="toggle1"
                                        onclick="togglePasswordVisibility('nuova_password', 'toggle1')">
                                        üëÅÔ∏è
                                    </span>
                                </div>
                                <div class="password-strength" id="passwordStrength"></div>
                                <small id="strengthText" class="form-text text-muted"></small>
                            </div>

                            <div class="mb-3">
                                <label for="conferma_password" class="form-label">Conferma Password</label>
                                <div class="password-input-wrapper">
                                    <input type="password" class="form-control" id="conferma_password"
                                        name="conferma_password" required>
                                    <span class="password-toggle" id="toggle2"
                                        onclick="togglePasswordVisibility('conferma_password', 'toggle2')">
                                        üëÅÔ∏è
                                    </span>
                                </div>
                                <small id="matchText" class="form-text"></small>
                            </div>

                            <button type="submit" class="btn btn-success w-100" id="submitBtn">Cambia Password</button>
                        </form>

                        <div id="errorMessage" class="mt-3 text-danger" style="display:none;"></div>
                        <div id="successMessage" class="mt-3 text-success" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        /**
         * Toggle visibilit√† password
         */
        function togglePasswordVisibility(inputId, toggleId) {
            const input = document.getElementById(inputId);
            const toggle = document.getElementById(toggleId);

            if (input.type === 'password') {
                input.type = 'text';
                toggle.textContent = 'üôà';
            } else {
                input.type = 'password';
                toggle.textContent = 'üëÅÔ∏è';
            }
        }

        /**
         * Valutazione forza password
         */
        function checkPasswordStrength(password) {
            let strength = 0;
            const strengthBar = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('strengthText');

            if (password.length === 0) {
                strengthBar.className = 'password-strength';
                strengthText.textContent = '';
                return;
            }

            // Criteri di valutazione
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            // Mostra indicatore forza
            strengthBar.className = 'password-strength';
            if (strength <= 2) {
                strengthBar.classList.add('strength-weak');
                strengthText.textContent = 'Password debole';
                strengthText.className = 'form-text text-danger';
            } else if (strength <= 4) {
                strengthBar.classList.add('strength-medium');
                strengthText.textContent = 'Password media';
                strengthText.className = 'form-text text-warning';
            } else {
                strengthBar.classList.add('strength-strong');
                strengthText.textContent = 'Password forte';
                strengthText.className = 'form-text text-success';
            }
        }

        /**
         * Verifica corrispondenza password
         */
        function checkPasswordMatch() {
            const password = document.getElementById('nuova_password').value;
            const confirm = document.getElementById('conferma_password').value;
            const matchText = document.getElementById('matchText');
            const submitBtn = document.getElementById('submitBtn');

            if (confirm.length === 0) {
                matchText.textContent = '';
                return;
            }

            if (password === confirm) {
                matchText.textContent = '‚úì Le password corrispondono';
                matchText.className = 'form-text text-success';
                submitBtn.disabled = false;
            } else {
                matchText.textContent = '‚úó Le password non corrispondono';
                matchText.className = 'form-text text-danger';
                submitBtn.disabled = true;
            }
        }

        // Event listeners per validazione in tempo reale
        document.getElementById('nuova_password').addEventListener('input', (e) => {
            checkPasswordStrength(e.target.value);
            checkPasswordMatch();
        });

        document.getElementById('conferma_password').addEventListener('input', checkPasswordMatch);

        /**
         * Gestione submit form cambio password
         */
        document.getElementById('cambioPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const password = document.getElementById('nuova_password').value;
            const confirm = document.getElementById('conferma_password').value;

            // Validazione finale
            if (password !== confirm) {
                showError('errorMessage', 'Le password non corrispondono');
                return;
            }

            if (password.length < 8) {
                showError('errorMessage', 'La password deve essere di almeno 8 caratteri');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Salvataggio in corso...';

            // Nascondi messaggi precedenti
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('nuova_password', password);

                const response = await fetch('/auth/cambiaPassword', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    // Password cambiata con successo!
                    showSuccess('successMessage', 'Password cambiata con successo! Reindirizzamento in corso...');

                    // Reindirizza al login dopo 2 secondi
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    showError('errorMessage', data.error || 'Errore durante il cambio password');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            } catch (error) {
                showError('errorMessage', 'Errore di connessione al server');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        /**
         * Funzione helper per mostrare errori
         */
        function showError(containerId, message) {
            const el = document.getElementById(containerId);
            if (el) {
                el.textContent = message;
                el.style.display = 'block';
                setTimeout(() => {
                    el.style.display = 'none';
                }, 5000);
            }
        }

        /**
         * Funzione helper per mostrare messaggi di successo
         */
        function showSuccess(containerId, message) {
            const el = document.getElementById(containerId);
            if (el) {
                el.textContent = message;
                el.style.display = 'block';
            }
        }

        /**
         * Verifica che l'utente abbia una sessione di reset verificata
         * (protezione contro accesso diretto alla pagina)
         */
        window.addEventListener('DOMContentLoaded', () => {
            // Solo un controllo base UI, la vera sicurezza √® nel backend
            // che verifica session['reset_verified']
        });
    </script>
</body>

</html>