<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Map4Aid - Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="../css/style.css">
  <style>
    /* miglioramento accessibilità: contrasto e dimensioni */
    .leaflet-popup-content {
      font-size: 1.05rem;
      line-height: 1.5;
    }
    .leaflet-popup .btn {
      min-height: 2.5rem;
      font-size: 1rem;
    }
    /* nascondi visivamente ma mantieni per screen reader ( accessibiltà ) */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <!-- Header dinamico -->
  <header class="header-bg text-white p-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <img src="../imgs/logo.png" alt="Logo Map4Aid" width="60" height="60" class="me-3 rounded-circle">
      <h1 class="h4 mb-0 ms-3">MAP4AID</h1>
    </div>
    <div class="d-flex gap-2" id="auth-buttons"></div>
  </header>

  <!-- area nascsta per feedack accessibilità (RF#12) -->
  <div id="a11y-status" aria-live="polite" class="sr-only"></div>

  <main class="container-fluid mt-3">
    <div class="row">
      <div class="col-md-3">
        <div class="sidebar">
          <!-- filtro categorie (requisito RF#6) -->
          <div class="mb-4">
            <label for="filtroCategoria" class="form-label fw-bold">Filtra per categoria</label>
            <select id="filtroCategoria" class="form-select">
              <option value="">Tutte le categorie</option>
              <option value="alimentari">Alimentari</option>
              <option value="medicinali">Medicinali</option>
              <option value="igiene">Igiene Personale</option>
              <option value="abbigliamento">Abbigliamento</option>
            </select>
          </div>

          <!-- Pulsante geolocalizzazione -->
          <button id="btnGeolocalizza" class="btn btn-success w-100 mb-4">Usa la mia posizione</button>

          <!-- accordion informativo (da mettere anche nel footer per niche del sito ) -->
          <div class="accordion" id="menuAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#chiSiamo">
                  Chi siamo
                </button>
              </h2>
              <div id="chiSiamo" class="accordion-collapse collapse" data-bs-parent="#menuAccordion">
                <div class="accordion-body">
                  Siamo un'organizzazione che aiuta chi ha bisogno.
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#missione">
                  La nostra missione
                </button>
              </h2>
              <div id="missione" class="accordion-collapse collapse" data-bs-parent="#menuAccordion">
                <div class="accordion-body">
                  Aiutare chi ha bisogno di beni primari.
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#partner">
                  I nostri partner
                </button>
              </h2>
              <div id="partner" class="accordion-collapse collapse" data-bs-parent="#menuAccordion">
                <div class="accordion-body">
                  Croce Rossa, Caritas, Comuni, ecc.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-9">
        <div id="map"></div>
        <div id="mappaStatus" class="mt-2 text-muted"></div>
      </div>
    </div>
  </main>
  <script src="../../chatbot/js/loader.js"></script>
  <!-- Footer ( oviamente ) -->
  <footer class="bg-dark text-white text-center py-3 mt-4">
    <p>&copy; 2026 Map4Aid - Progetto Universitario</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // inizializza la mappa con opzioni accessibili (tastiera, zoom)
    const map = L.map('map', {
      keyboard: true,
      keyboardPanOffset: 80,
      keyboardZoomOffset: 1
    }).setView([41.8902, 12.4922], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // DATI SIMULATI (fallback se l'API non è disponibile ( per testing ) )
    const puntiSimulati = [
      {
        id: 1,
        nome: "Centro Colosseo",
        indirizzo: "Via del Colosseo, 1, Roma",
        lat: 41.8902,
        lng: 12.4922,
        categoria: "alimentari",
        beni: ["Pasta", "Riso", "Olio"]
      },
      {
        id: 2,
        nome: "Centro Termini",
        indirizzo: "Piazza dei Cinquecento, Roma",
        lat: 41.9009,
        lng: 12.5027,
        categoria: "medicinali",
        beni: ["Paracetamolo", "Vitamine", "Cerotti"]
      },
      {
        id: 3,
        nome: "Centro San Giovanni",
        indirizzo: "Via Appia Nuova, Roma",
        lat: 41.8756,
        lng: 12.5258,
        categoria: "igiene",
        beni: ["Sapone", "Shampoo", "Dentifricio"]
      },
      {
        id: 4,
        nome: "Centro EUR",
        indirizzo: "Viale Europa, Roma",
        lat: 41.8330,
        lng: 12.4680,
        categoria: "abbigliamento",
        beni: ["Maglie", "Pantaloni", "Giacche"]
      }
    ];

    let markerCorrenti = [];

    /**
     * aggiunge marker accessibili alla mappa
     * coerente con RF#12 (accessibilità per disabilità motorie/visive)
     */
    function aggiungiMarker(punti) {
      markerCorrenti.forEach(marker => map.removeLayer(marker));
      markerCorrenti = [];

      punti.forEach(punto => {
        const marker = L.marker([punto.lat, punto.lng], {
          keyboard: true,
          alt: `Punto di distribuzione: ${punto.nome}`
        }).addTo(map);

        // apri popup con Enter/Space (accessibilità tastiera ( funziona,  ma da rivedere meglio ) ) 
        marker.on('keypress', function(e) {
          if (e.originalEvent.key === 'Enter' || e.originalEvent.key === ' ') {
            this.openPopup();
          }
        });

        // popup con struttura semantica e aria-label
        marker.bindPopup(`
          <div role="region" aria-labelledby="popup-title-${punto.id}">
            <h3 id="popup-title-${punto.id}">${punto.nome}</h3>
            <p>${punto.indirizzo}</p>
            <p><strong>Categoria:</strong> ${punto.categoria}</p>
            <p><strong>Beni disponibili:</strong> ${punto.beni.join(', ')}</p>
            <button 
              class="btn btn-sm btn-primary mt-2"
              aria-label="Prenota bene al ${punto.nome}"
              onclick="apriPrenotazione(${punto.id})">
              Prenota
            </button>
          </div>
        `);

        markerCorrenti.push(marker);
      });
    }

    /**
     * apre la pagina di prenotazione per un punto specifico
     * se non loggato, mostra errore e reindirizza al login
     */
    function apriPrenotazione(idPunto) {
      document.getElementById('a11y-status').textContent = 
        `Apertura modulo prenotazione per il punto ID: ${idPunto}`;

      if (!sessionStorage.getItem('isLoggedIn')) {
        showError('mappaStatus', 'Devi effettuare il login per prenotare un bene');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
        return;
      }
      window.location.href = `prenotazione.html?id=${idPunto}`;
    }

    /**
     * carica i punti di distribuzione dall'API o dal mock
     */
    async function caricaPunti() {
      try {
        // chiamata all'endpoint reale ( esiste in api_punti.py ( per adesso ) )
        const response = await fetch('/api/punti-distribuzione');
        if (!response.ok) throw new Error('API non disponibile');
        
        const data = await response.json();
        // mappa i dati dell'API al formato atteso
        return data.data.map(p => ({
          id: p.id,
          nome: p.nome || 'Punto senza nome',
          indirizzo: `${p.citta || ''}, ${p.regione || ''}`.trim() || 'Indirizzo non disponibile',
          lat: p.latitudine,
          lng: p.longitudine,
          categoria: "generico",
          beni: ["Bene disponibile"]
        }));
      } catch (error) {
        console.warn("Fallback a dati simulati:", error);
        return puntiSimulati;
      }
    }

    // inizializza la mappa con i punti
    caricaPunti().then(punti => {
      aggiungiMarker(punti);
    });

    // gestione filtro categorie
    document.getElementById('filtroCategoria').addEventListener('change', (e) => {
      const categoria = e.target.value;
      caricaPunti().then(punti => {
        if (categoria === '') {
          aggiungiMarker(punti);
        } else {
          const filtrati = punti.filter(p => p.categoria === categoria);
          aggiungiMarker(filtrati);
        }
      });
    });

    // geolocalizzazione con gestione errori
    document.getElementById('btnGeolocalizza').addEventListener('click', () => {
      const statusDiv = document.getElementById('mappaStatus');
      statusDiv.innerHTML = '<div class="text-center">Ricerca della tua posizione...</div>';

      if (!navigator.geolocation) {
        showError('mappaStatus', 'Geolocalizzazione non supportata dal browser');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          map.setView([lat, lng], 14);
          statusDiv.innerHTML = `✅ Posizione trovata: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
          document.getElementById('a11y-status').textContent = 
            `Mappa centrata sulla tua posizione: latitudine ${lat.toFixed(4)}, longitudine ${lng.toFixed(4)}`;
        },
        (error) => {
          let msg = 'Impossibile ottenere la posizione.';
          if (error.code === error.PERMISSION_DENIED) {
            msg = 'Permesso negato. Attiva la geolocalizzazione nelle impostazioni del browser.';
          }
          showError('mappaStatus', msg);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    });
  </script>
  <script src="../js/auth.js"></script>
</body>
</html>
