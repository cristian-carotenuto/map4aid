<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Map4Aid - Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='static/css/style.css') }}">
  <style>
    .leaflet-popup-content { font-size: 1.05rem; line-height: 1.5; }
    .leaflet-popup .btn { min-height: 2.5rem; font-size: 1rem; }
    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }
    #routeInfo { display: none; }
    #routeInfo.active { display: block; }
    .segnalazione-attiva { cursor: crosshair !important; }
    .segnalazione-attiva .leaflet-grab { cursor: crosshair !important; }
    #btnSegnalaMappa.active { background-color: #dc3545; border-color: #dc3545; color: #fff; }
    .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; gap: 0.25rem; }
    .star-rating input { display: none; }
    .star-rating label { font-size: 2rem; color: #ddd; cursor: pointer; transition: color 0.2s; }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label { color: #ffc107; }
    .star-rating label:hover ~ label { color: #ffc107; }    
  </style>
</head>
<body>
  <!-- Header dinamico -->
  <header class="header-bg text-white p-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <img src="{{ url_for('static', filename='static/imgs/logo.png') }}" alt="Logo Map4Aid" width="60" height="60" class="me-3 rounded-circle">
      <h1 class="h4 mb-0 ms-3">MAP4AID</h1>
    </div>
    <div class="d-flex gap-2" id="auth-buttons"></div>
  </header>

  <main class="container-fluid mt-3">
    <!-- Area nascosta per feedback accessibilit√† (RF#12) -->
    <div id="a11y-status" aria-live="polite" class="sr-only"></div>
    <div class="row">
      <div class="col-md-3">
        <div class="sidebar">
          <!-- Filtro categorie (RF#6) -->
          <div class="mb-4">
            <label for="filtroCategoria" class="form-label fw-bold">Filtra per categoria</label>
            <select id="filtroCategoria" class="form-select">
              <option value="">Tutte le categorie</option>
              <option value="alimentare">Alimentari</option>
              <option value="medicinali">Medicinali</option>
              <option value="igiene">Igiene Personale</option>
              <option value="vestiario">Abbigliamento</option>
            </select>
          </div>

          <!-- Pulsante geolocalizzazione -->
          <button id="btnGeolocalizza" class="btn btn-success w-100 mb-3">Usa la mia posizione</button>

          <!-- Pulsante segnalazione punto (toggle modalit√† click sulla mappa) -->
          <button id="btnSegnalaMappa" class="btn btn-warning w-100 mb-3">üìç Segnala un punto di raccolta</button>
          <div id="segnalazioneHint" class="alert alert-warning py-2 mb-3" style="display:none;">
            Clicca sulla mappa per selezionare il punto da segnalare. <br>
            <button class="btn btn-sm btn-outline-dark mt-1" onclick="toggleSegnalazioneMode()">Annulla</button>
          </div>

          <!-- Pulsante feedback -->
          <button id="btnFeedback" class="btn btn-info text-white w-100 mb-3" onclick="apriFeedbackModal()">Lascia un feedback</button>       
          
          <!-- Pulsante calcolo percorso AI -->
          <button id="btnCalcolaPercorso" class="btn btn-primary w-100 mb-3" style="display:none;">
            ü§ñ Calcola percorso AI ottimale
          </button>

          <!-- Info percorso -->
          <div id="routeInfo" class="alert alert-info mb-3">
            <h6 class="mb-1">üìç Percorso AI calcolato</h6>
            <p class="mb-1" id="routeDetails"></p>
            <button class="btn btn-sm btn-outline-danger" id="btnRimuoviPercorso">Rimuovi percorso</button>
          </div>

          <!-- Accordion informativo -->
          <div class="accordion" id="menuAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#chiSiamo">
                  Chi siamo
                </button>
              </h2>
              <div id="chiSiamo" class="accordion-collapse collapse" data-bs-parent="#menuAccordion">
                <div class="accordion-body">Map4Aid √® una piattaforma digitale che mette in connessione enti solidali e cittadini attraverso una mappa interattiva.
  Il nostro obiettivo √® facilitare l‚Äôaccesso ai beni primari, rendendo visibili in tempo reale i punti di distribuzione
  e le risorse disponibili sul territorio.</div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#missione">
                  La nostra missione
                </button>
              </h2>
              <div id="missione" class="accordion-collapse collapse" data-bs-parent="#menuAccordion">
                <div class="accordion-body">  La nostra missione √® ridurre le difficolt√† di accesso ai beni essenziali tramite uno strumento tecnologico
  semplice, trasparente e scalabile. Map4Aid consente di individuare rapidamente strutture che offrono cibo,
  medicinali e altri beni di prima necessit√†, migliorando il coordinamento tra enti e comunit√† locali.</div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#partner">
                  I nostri partner
                </button>
              </h2>
              <div id="partner" class="accordion-collapse collapse" data-bs-parent="#menuAccordion">
                <div class="accordion-body"> Collaboriamo con organizzazioni del terzo settore, enti pubblici e associazioni di volontariato
  come Croce Rossa, Caritas e amministrazioni comunali. I partner contribuiscono aggiornando
  le informazioni sui beni disponibili e garantendo l‚Äôaffidabilit√† dei dati pubblicati sulla piattaforma.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-9">
        <div id="map"></div>
        <div id="mappaStatus" class="mt-2 text-muted"></div>
        <div id="errorMessage" class="mt-2 text-danger" style="display:none;"></div>
      </div>
    </div>
  </main>
  <!-- Modal Feedback -->
  <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="feedbackModalLabel">Lascia un Feedback</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted">Seleziona una prenotazione ritirata e lascia la tua valutazione.</p>
          <div class="mb-3">
            <label for="feedbackPrenotazione" class="form-label">Prenotazione</label>
            <select class="form-select" id="feedbackPrenotazione" required>
              <option value="" disabled selected>Caricamento...</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Valutazione</label>
            <div class="star-rating">
              <input type="radio" id="fStar5" name="feedbackValutazione" value="5"><label for="fStar5">&#9733;</label>
              <input type="radio" id="fStar4" name="feedbackValutazione" value="4"><label for="fStar4">&#9733;</label>
              <input type="radio" id="fStar3" name="feedbackValutazione" value="3"><label for="fStar3">&#9733;</label>
              <input type="radio" id="fStar2" name="feedbackValutazione" value="2"><label for="fStar2">&#9733;</label>
              <input type="radio" id="fStar1" name="feedbackValutazione" value="1"><label for="fStar1">&#9733;</label>
            </div>
          </div>
          <div class="mb-3">
            <label for="feedbackRecensione" class="form-label">Recensione <small class="text-muted">(facoltativa)</small></label>
            <textarea class="form-control" id="feedbackRecensione" rows="3" placeholder="Scrivi qui la tua esperienza..."></textarea>
          </div>
          <div id="feedbackModalError" class="text-danger" style="display:none;"></div>
          <div id="feedbackModalSuccess" class="text-success" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-success" id="btnInviaFeedback">Invia Feedback</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Segnalazione -->
  <div class="modal fade" id="segnalazioneModal" tabindex="-1" aria-labelledby="segnalazioneModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="segnalazioneModalLabel">Segnala punto di raccolta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted">Conferma i dati del punto selezionato sulla mappa.</p>
          <div class="mb-3">
            <label for="segnalazioneIndirizzo" class="form-label">Indirizzo</label>
            <input type="text" class="form-control" id="segnalazioneIndirizzo" placeholder="Caricamento indirizzo...">
          </div>
          <div class="row mb-3">
            <div class="col">
              <label class="form-label">Latitudine</label>
              <input type="text" class="form-control" id="segnalazioneLat" readonly>
            </div>
            <div class="col">
              <label class="form-label">Longitudine</label>
              <input type="text" class="form-control" id="segnalazioneLng" readonly>
            </div>
          </div>
          <div id="segnalazioneModalError" class="text-danger" style="display:none;"></div>
          <div id="segnalazioneModalSuccess" class="text-success" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-success" id="btnInviaSegnalazione">Invia segnalazione</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-3 mt-4">
    <p>&copy; 2026 Map4Aid - Progetto Universitario</p>
    <p class="mb-0" id="adminAccessLink"><a href="/admin-login" class="text-white-50 small">Accesso amministratore</a></p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="{{ url_for('static', filename='static/js/auth.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const adminLink = document.getElementById('adminAccessLink');
      if (adminLink) {
        adminLink.style.display = isLoggedIn() ? 'none' : '';
      }
    });
  </script>
  <script>
    // ====== MAPPA ======
    const map = L.map('map', {
      keyboard: true,
      keyboardPanOffset: 80,
      keyboardZoomOffset: 1
    }).setView([41.8902, 12.4922], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // ====== DATI SIMULATI ======
    const puntiSimulati = [
      { id: 1, nome: "Centro Colosseo", indirizzo: "Via del Colosseo, 1, Roma", lat: 41.8902, lng: 12.4922, categoria: "alimentari", beni: ["Pasta", "Riso", "Olio"] },
      { id: 2, nome: "Centro Termini", indirizzo: "Piazza dei Cinquecento, Roma", lat: 41.9009, lng: 12.5027, categoria: "medicinali", beni: ["Paracetamolo", "Vitamine", "Cerotti"] },
      { id: 3, nome: "Centro San Giovanni", indirizzo: "Via Appia Nuova, Roma", lat: 41.8756, lng: 12.5258, categoria: "igiene", beni: ["Sapone", "Shampoo", "Dentifricio"] },
      { id: 4, nome: "Centro EUR", indirizzo: "Viale Europa, Roma", lat: 41.8330, lng: 12.4680, categoria: "abbigliamento", beni: ["Maglie", "Pantaloni", "Giacche"] }
    ];

    let markerCorrenti = [];
    let puntiCaricati = [];
    let posizioneUtente = null;
    let routeLayer = null;

    // ====== MARKER ACCESSIBILI ======
    function aggiungiMarker(punti) {
      markerCorrenti.forEach(m => map.removeLayer(m));
      markerCorrenti = [];
      puntiCaricati = punti;

      punti.forEach(async (punto) => { // Aggiungiamo 'async' qui
  const marker = L.marker([punto.lat, punto.lng], {
    keyboard: true,
    alt: 'Punto di distribuzione: ' + punto.nome
  }).addTo(map);

  // 1. Creiamo un contenuto iniziale temporaneo
  marker.bindPopup(`Caricamento indirizzo...`);

  // 2. Al click sul marker, recuperiamo l'indirizzo reale
  marker.on('click', async function() {
    try {
      // Chiamata a Nominatim per il Reverse Geocoding
      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${punto.lat}&lon=${punto.lng}`);
      const data = await response.json();

      // Estraiamo l'indirizzo (o un fallback se non trovato)
      const indirizzoReale = data.display_name || "Indirizzo non identificato";

      // 3. Aggiorniamo il contenuto del popup con l'indirizzo trovato
      const popupContent = `
        <div role="region" aria-labelledby="popup-title-${punto.id}">
          <h3 id="popup-title-${punto.id}">${punto.nome}</h3>
          <p>üìç ${indirizzoReale}</p>
          <p><strong>Categoria:</strong> ${punto.categoria}</p>
          <button class="btn btn-sm btn-primary mt-2" onclick="apriPrenotazione(${punto.id})">Prenota</button>
          <button class="btn btn-sm btn-outline-primary mt-2 ms-1" onclick="calcolaPercorsoVerso(${punto.lat},${punto.lng},'${punto.nome.replace(/'/g, "\\'")}')">üó∫Ô∏è Percorso</button>
          <button class="btn btn-sm btn-warning mt-2 ms-1" onclick="apriFeedbackPunto(${punto.id})">Feedback</button>
        </div>
      `;

      marker.setPopupContent(popupContent);
    } catch (error) {
      console.error("Errore Geocoding:", error);
      marker.setPopupContent("Impossibile recuperare l'indirizzo");
    }
  });

  markerCorrenti.push(marker);
});

      document.getElementById('btnCalcolaPercorso').style.display =
        (posizioneUtente && punti.length > 0) ? 'block' : 'none';
    }

    // ====== APRI PRENOTAZIONE ======
    function apriPrenotazione(idPunto) {
      document.getElementById('a11y-status').textContent = `Apertura modulo prenotazione per il punto ID: ${idPunto}`;
      if (!sessionStorage.getItem('isLoggedIn')) {
        showError('mappaStatus', 'Devi effettuare il login per prenotare un bene');
        setTimeout(() => { window.location.href = '/login'; }, 2000);
        return;
      }
      window.location.href = `/prenotazione?id=${idPunto}`;
    }

    // ====== CARICA PUNTI ======
   async function caricaPunti(categoria = "") {
  try {
    // 1. Costruiamo l'URL corretto per il backend
    let url = '/api/punti-distribuzione';
    if (categoria) {
      url += `?categoria=${encodeURIComponent(categoria)}`;
    }

    const response = await fetch(url);
    if (!response.ok) throw new Error('Risposta del server non valida');

    const result = await response.json();

    // Se il server restituisce dati vuoti, non passare ai simulati,
    // restituisci un array vuoto (cos√¨ la mappa si pulisce correttamente)
    if (!result.data || result.data.length === 0) {
      return [];
    }

    // 2. Mappatura dei dati reali (convertiamo i nomi delle colonne SQL in quelli della mappa)
    return result.data.map(p => ({
      id: p.id,
      nome: p.nome || 'Punto senza nome',
      // Usiamo i campi che hai nel backend (regione, citta, ecc.)
      indirizzo: p.indirizzo || `${p.citta || ''} ${p.regione || ''}`.trim() || 'Indirizzo non disponibile',
      lat: p.latitudine,
      lng: p.longitudine,
      categoria: categoria || "Tutte",
      beni: ["Disponibilit√† verificata dal sistema"]
    }));

  } catch (error) {
    console.error("Errore critico caricamento punti:", error);
    // Visualizziamo l'errore nella UI
    showError('errorMessage', 'Connessione al database fallita. Visualizzazione dati offline.');

    // SOLO in caso di errore di rete restituiamo i 4 punti di test
    return categoria === '' ? puntiSimulati : puntiSimulati.filter(p => p.categoria === categoria);
  }
}

    caricaPunti().then(punti => aggiungiMarker(punti));

    // ====== FILTRO CATEGORIE AGGIORNATO (LATO SERVER) ======
  document.getElementById('filtroCategoria').addEventListener('change', async (e) => {
  const cat = e.target.value;
  const statusDiv = document.getElementById('mappaStatus');

  // Feedback visivo
  statusDiv.innerHTML = '‚è≥ Aggiornamento mappa in corso...';

  try {
    // Chiamiamo la funzione caricaPunti passando la categoria selezionata
    const punti = await caricaPunti(cat);

    // La funzione aggiungiMarker() pulisce gi√† i vecchi e mette i nuovi
    aggiungiMarker(punti);

    if (punti.length === 0) {
      statusDiv.innerHTML = `‚ö†Ô∏è Nessun punto disponibile per la categoria: <strong>${cat}</strong>`;
    } else {
      statusDiv.innerHTML = `‚úÖ Trovati ${punti.length} punti per ${cat || 'tutte le categorie'}`;
    }
  } catch (error) {
    showError('errorMessage', 'Errore nel caricamento dei dati filtrati.');
  }
});

    // ====== GEOLOCALIZZAZIONE ======
    document.getElementById('btnGeolocalizza').addEventListener('click', () => {
      const statusDiv = document.getElementById('mappaStatus');
      statusDiv.innerHTML = '<div class="text-center">Ricerca della tua posizione...</div>';

      if (!navigator.geolocation) {
        showError('mappaStatus', 'Geolocalizzazione non supportata dal browser');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          posizioneUtente = { lat, lng };
          map.setView([lat, lng], 14);

          L.marker([lat, lng], {
            icon: L.divIcon({
              className: 'bg-primary rounded-circle border border-white',
              iconSize: [16, 16]
            })
          }).addTo(map).bindPopup('<strong>La tua posizione</strong>');

          statusDiv.innerHTML = `‚úÖ Posizione trovata: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
          document.getElementById('a11y-status').textContent =
            `Mappa centrata sulla tua posizione: latitudine ${lat.toFixed(4)}, longitudine ${lng.toFixed(4)}`;

          if (puntiCaricati.length > 0) {
            document.getElementById('btnCalcolaPercorso').style.display = 'block';
          }
        },
        (error) => {
          let msg = 'Impossibile ottenere la posizione.';
          if (error.code === error.PERMISSION_DENIED) {
            msg = 'Permesso negato. Attiva la geolocalizzazione nelle impostazioni del browser.';
          }
          showError('mappaStatus', msg);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    });

    // ====== PERCORSO AI (con fallback mock frontend) ======
    document.getElementById('btnCalcolaPercorso').addEventListener('click', async () => {
      if (!posizioneUtente) {
        showError('errorMessage', 'Prima utilizza "Usa la mia posizione" per geolocalizzarti');
        return;
      }
      if (puntiCaricati.length === 0) {
        showError('errorMessage', 'Nessun punto di distribuzione disponibile');
        return;
      }

      const btn = document.getElementById('btnCalcolaPercorso');
      btn.disabled = true;
      btn.textContent = '‚è≥ Calcolo in corso...';

      try {
        const response = await fetch('/api/percorso-ai', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            origine: posizioneUtente,
            punti: puntiCaricati.map(p => ({ id: p.id, nome: p.nome, lat: p.lat, lng: p.lng, categoria: p.categoria })),
            preferenza: document.getElementById('filtroCategoria').value || 'tutti'
          })
        });

        const data = await response.json();
        if (response.ok && data.percorso) {
          disegnaPercorso(data.percorso, data.info);
        } else {
          throw new Error('API non disponibile');
        }
      } catch (error) {
        // ‚úÖ Fallback: calcolo percorso mock lato frontend (nearest-neighbor greedy)
        console.warn('Fallback a calcolo percorso locale:', error);
        const catFiltro = document.getElementById('filtroCategoria').value;
        let puntiFiltrati = catFiltro ? puntiCaricati.filter(p => p.categoria === catFiltro) : [...puntiCaricati];

        if (puntiFiltrati.length === 0) {
          showError('errorMessage', 'Nessun punto disponibile per la categoria selezionata');
          btn.disabled = false;
          btn.textContent = 'ü§ñ Calcola percorso AI ottimale';
          return;
        }

        // Algoritmo greedy nearest-neighbor
        const percorso = [[posizioneUtente.lat, posizioneUtente.lng]];
        let corrente = { lat: posizioneUtente.lat, lng: posizioneUtente.lng };
        const visitati = new Set();
        let distanzaTotale = 0;

        while (visitati.size < puntiFiltrati.length) {
          let minDist = Infinity;
          let prossimo = null;
          let prossimoIdx = -1;

          puntiFiltrati.forEach((p, i) => {
            if (!visitati.has(i)) {
              const d = calcolaDistanzaKm(corrente.lat, corrente.lng, p.lat, p.lng);
              if (d < minDist) { minDist = d; prossimo = p; prossimoIdx = i; }
            }
          });

          if (prossimo) {
            visitati.add(prossimoIdx);
            percorso.push([prossimo.lat, prossimo.lng]);
            distanzaTotale += minDist;
            corrente = { lat: prossimo.lat, lng: prossimo.lng };
          }
        }

        disegnaPercorso(percorso, {
          descrizione: 'Percorso ottimale (calcolo locale)',
          distanza_totale_km: distanzaTotale.toFixed(2),
          n_tappe: puntiFiltrati.length
        });
      } finally {
        btn.disabled = false;
        btn.textContent = 'ü§ñ Calcola percorso AI ottimale';
      }
    });

    // ====== PERCORSO SINGOLO ======
    function calcolaPercorsoVerso(lat, lng, nome) {
      if (!posizioneUtente) {
        showError('errorMessage', 'Prima utilizza "Usa la mia posizione" per geolocalizzarti');
        return;
      }
      const percorso = [[posizioneUtente.lat, posizioneUtente.lng], [lat, lng]];
      disegnaPercorso(percorso, {
        distanza_totale_km: calcolaDistanzaKm(posizioneUtente.lat, posizioneUtente.lng, lat, lng).toFixed(2),
        descrizione: 'Percorso verso ' + nome,
        n_tappe: 1
      });
    }

    // ====== DISEGNA PERCORSO ======
    function disegnaPercorso(percorso, info) {
      if (routeLayer) map.removeLayer(routeLayer);
      routeLayer = L.polyline(percorso, {
        color: '#0d6efd',
        weight: 5,
        opacity: 0.8,
        dashArray: '10, 8',
        lineJoin: 'round'
      }).addTo(map);
      map.fitBounds(routeLayer.getBounds(), { padding: [40, 40] });

      const routeInfoDiv = document.getElementById('routeInfo');
      routeInfoDiv.classList.add('active');
      document.getElementById('routeDetails').innerHTML =
        `<strong>${info.descrizione || 'Percorso ottimale'}</strong><br>` +
        `üìè Distanza (in linea d‚Äôaria): ~${info.distanza_totale_km} km` +
        (info.n_tappe ? `<br>üìç Tappe: ${info.n_tappe}` : '');
    }

    // ====== RIMUOVI PERCORSO ======
    document.getElementById('btnRimuoviPercorso').addEventListener('click', () => {
      if (routeLayer) map.removeLayer(routeLayer);
      routeLayer = null;
      document.getElementById('routeInfo').classList.remove('active');
    });

    // ====== UTILIT√Ä ======
    function calcolaDistanzaKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // ====== SEGNALAZIONE DA MAPPA ======
    let segnalazioneMode = false;
    let segnalazioneMarker = null;

    /**
     * Attiva/disattiva la modalit√† segnalazione
     */
    function toggleSegnalazioneMode() {
      segnalazioneMode = !segnalazioneMode;
      const btn = document.getElementById('btnSegnalaMappa');
      const hint = document.getElementById('segnalazioneHint');
      const mapDiv = document.getElementById('map');

      if (segnalazioneMode) {
        btn.classList.add('active');
        btn.textContent = 'Modalit√† segnalazione attiva';
        hint.style.display = 'block';
        mapDiv.classList.add('segnalazione-attiva');
      } else {
        btn.classList.remove('active');
        btn.textContent = 'Segnala un punto sulla mappa';
        hint.style.display = 'none';
        mapDiv.classList.remove('segnalazione-attiva');
        if (segnalazioneMarker) {
          map.removeLayer(segnalazioneMarker);
          segnalazioneMarker = null;
        }
      }
    }

    document.getElementById('btnSegnalaMappa').addEventListener('click', toggleSegnalazioneMode);

    /**
     * Click sulla mappa in modalit√† segnalazione:
     * piazza un marker e apre il modal con reverse geocoding
     */
    map.on('click', async function(e) {
      if (!segnalazioneMode) return;

      const lat = e.latlng.lat;
      const lng = e.latlng.lng;

      // Rimuovi marker precedente
      if (segnalazioneMarker) map.removeLayer(segnalazioneMarker);

      // Icona rossa per distinguere dal marker dei punti
      const redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
      });

      segnalazioneMarker = L.marker([lat, lng], { icon: redIcon }).addTo(map);
      segnalazioneMarker.bindPopup('<strong>Punto da segnalare</strong>').openPopup();

      // Popola il modal
      document.getElementById('segnalazioneLat').value = lat.toFixed(6);
      document.getElementById('segnalazioneLng').value = lng.toFixed(6);
      document.getElementById('segnalazioneIndirizzo').value = 'Caricamento indirizzo...';
      document.getElementById('segnalazioneModalError').style.display = 'none';
      document.getElementById('segnalazioneModalSuccess').style.display = 'none';
      document.getElementById('btnInviaSegnalazione').disabled = false;
      document.getElementById('btnInviaSegnalazione').textContent = 'Invia segnalazione';

      // Reverse geocoding tramite Nominatim
      try {
        const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=it`);
        const data = await resp.json();
        document.getElementById('segnalazioneIndirizzo').value = data.display_name || '';
      } catch {
        document.getElementById('segnalazioneIndirizzo').value = '';
      }

      // Apri il modal
      const modal = new bootstrap.Modal(document.getElementById('segnalazioneModal'));
      modal.show();
    });

    /**
     * Invio della segnalazione al backend POST /auth/segnalazione
     */
    document.getElementById('btnInviaSegnalazione').addEventListener('click', async () => {
      const indirizzo = document.getElementById('segnalazioneIndirizzo').value.trim();
      const lat = document.getElementById('segnalazioneLat').value;
      const lng = document.getElementById('segnalazioneLng').value;

      if (!indirizzo) {
        showError('segnalazioneModalError', "Inserisci un indirizzo valido");
        return;
      }

      const btn = document.getElementById('btnInviaSegnalazione');
      btn.disabled = true;
      btn.textContent = 'Invio in corso...';

      try {
        const formData = new FormData();
        formData.append('latitudine', lat);
        formData.append('longitudine', lng);
        formData.append('indirizzo', indirizzo);

        const response = await fetch('/auth/segnalazione', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (response.ok && data.successo) {
          showSuccess('segnalazioneModalSuccess', 'Segnalazione inviata con successo!');
          setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('segnalazioneModal')).hide();
            toggleSegnalazioneMode();
          }, 2000);
        } else {
          showError('segnalazioneModalError', data.messaggio || 'Errore durante la segnalazione');
        }
      } catch {
        showError('segnalazioneModalError', 'Errore di connessione al server');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Invia segnalazione';
      }
    });

    // Cleanup: quando il modal si chiude, rimuovi il marker se la segnalazione non √® stata inviata
    document.getElementById('segnalazioneModal').addEventListener('hidden.bs.modal', () => {
      if (segnalazioneMarker && segnalazioneMode) {
        map.removeLayer(segnalazioneMarker);
        segnalazioneMarker = null;
      }
    });

    // ====== FEEDBACK DA HOME ======

    function apriFeedbackPunto(idPunto) {
      window.location.href = `/feedback-punto?id=${idPunto}`;
    }

    /**
     * Apre il modal feedback dopo aver verificato il login
     * e caricato le prenotazioni ritirate
     */
    async function apriFeedbackModal() {
      if (!sessionStorage.getItem('isLoggedIn')) {
        showError('errorMessage', 'Devi effettuare il login per lasciare un feedback');
        setTimeout(() => { window.location.href = '/login'; }, 2000);
        return;
      }

      // Reset stato modal
      document.getElementById('feedbackModalError').style.display = 'none';
      document.getElementById('feedbackModalSuccess').style.display = 'none';
      document.getElementById('feedbackRecensione').value = '';
      document.querySelectorAll('input[name="feedbackValutazione"]').forEach(r => r.checked = false);
      document.getElementById('btnInviaFeedback').disabled = false;
      document.getElementById('btnInviaFeedback').textContent = 'Invia Feedback';

      const select = document.getElementById('feedbackPrenotazione');
      select.innerHTML = '<option value="" disabled selected>Caricamento...</option>';

      const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
      modal.show();

      // Carica prenotazioni ritirate
      try {
        const response = await fetch('/auth/prenotazioni');
        if (!response.ok) throw new Error('Errore');
        const prenotazioni = await response.json();
        const ritirate = prenotazioni.filter(p => p.stato === 'ritirata');

        select.innerHTML = '';
        if (ritirate.length === 0) {
          select.innerHTML = '<option value="" disabled selected>Nessuna prenotazione ritirata disponibile</option>';
          document.getElementById('btnInviaFeedback').disabled = true;
          return;
        }

        select.innerHTML = '<option value="" disabled selected>Seleziona una prenotazione...</option>';
        ritirate.forEach(p => {
          const option = document.createElement('option');
          option.value = p.id;
          option.textContent = `#${p.id} - ${p.bene} (${p.data})`;
          select.appendChild(option);
        });
      } catch {
        select.innerHTML = '<option value="" disabled selected>Errore nel caricamento</option>';
        showError('feedbackModalError', 'Impossibile caricare le prenotazioni.');
      }
    }

    /**
     * Invio del feedback al backend POST /api/feedback
     */
    document.getElementById('btnInviaFeedback').addEventListener('click', async () => {
      const idPrenotazione = parseInt(document.getElementById('feedbackPrenotazione').value);
      const valutazioneEl = document.querySelector('input[name="feedbackValutazione"]:checked');
      const recensione = document.getElementById('feedbackRecensione').value.trim() || null;

      if (!idPrenotazione) {
        showError('feedbackModalError', 'Seleziona una prenotazione');
        return;
      }
      if (!valutazioneEl) {
        showError('feedbackModalError', 'Seleziona una valutazione (da 1 a 5 stelle)');
        return;
      }

      const btn = document.getElementById('btnInviaFeedback');
      btn.disabled = true;
      btn.textContent = 'Invio in corso...';

      try {
        const response = await fetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_email: getUserEmail(),
            id_prenotazione: idPrenotazione,
            valutazione: parseInt(valutazioneEl.value),
            recensione: recensione
          })
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess('feedbackModalSuccess', 'Feedback inviato con successo!');
          setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
          }, 2000);
        } else {
          showError('feedbackModalError', data.error || 'Errore durante l\'invio del feedback');
        }
      } catch {
        showError('feedbackModalError', 'Errore di connessione al server');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Invia Feedback';
      }
    });
  </script>
  <!-- Chatbot integrato -->
  <script src="../chatbot/js/loader.js"></script>
</body>
</html>
