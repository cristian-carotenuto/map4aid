<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Prenota Bene - Map4Aid</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .step { display: none; }
    .step.active { display: block; }
    .bene-card { cursor: pointer; transition: all 0.2s; }
    .bene-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .slot-badge { font-size: 0.9em; padding: 0.4em 0.6em; }
    .qr-placeholder { background-color: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; padding: 2rem; text-align: center; }
  </style>
</head>
<body class="bg-light">
  <!-- Header dinamico -->
  <header class="header-bg text-white p-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <img src="../imgs/logo.png" alt="Logo Map4Aid" width="60" height="60" class="me-3 rounded-circle">
      <h1 class="h4 mb-0 ms-3">MAP4AID</h1>
    </div>
    <div class="d-flex gap-2" id="auth-buttons"></div>
  </header>

  <div class="container mt-4">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">Prenotazione bene</h4>
          </div>
          <div class="card-body">
            <!-- Step 1: Selezione bene -->
            <div id="step1" class="step active">
              <h5 class="mb-3">Seleziona il bene da prenotare</h5>
              <div id="beniContainer" class="row g-3">
                <!-- I beni verranno caricati qui -->
              </div>
              <div id="errorMessage" class="mt-3 text-danger" style="display:none;"></div>
            </div>

            <!-- Step 2: Selezione slot -->
            <div id="step2" class="step">
              <h5 class="mb-3">Seleziona lo slot orario</h5>
              <div id="slotContainer" class="row g-3">
                <!-- Gli slot verranno caricati qui -->
              </div>
              <div class="mt-3">
                <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Indietro</button>
                <button type="button" class="btn btn-primary" id="confermaPrenotazioneBtn">Conferma Prenotazione</button>
              </div>
            </div>

            <!-- Step 3: QR Code -->
            <div id="step3" class="step">
              <h5 class="mb-3">Prenotazione confermata!</h5>
              <div class="qr-placeholder">
                <div class="mb-3">
                  <strong>QR Code della tua prenotazione</strong>
                </div>
                <div id="qrCodePlaceholder" class="text-muted">
                  Il QR code verrà generato dal server
                </div>
                <div class="mt-3">
                  <button class="btn btn-success" onclick="window.print()">Stampa QR Code</button>
                </div>
              </div>
              <div class="mt-3">
                <a href="home.html" class="btn btn-primary">Torna alla home</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-3 mt-4">
    <p>&copy; 2026 Map4Aid - Progetto Universitario</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    // Dati globali
    let puntoId = null;
    let beneSelezionato = null;
    let slotSelezionato = null;

    // Protezione: solo utenti loggati
    if (!sessionStorage.getItem('isLoggedIn')) {
      showError('errorMessage', 'Devi effettuare il login per prenotare un bene');
      setTimeout(() => window.location.href = 'login.html', 2000);
    }

    /**
     * Estrae l'ID del punto dall'URL
     */
    function getPointIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    /**
     * Carica i beni disponibili per il punto
     */
    async function caricaBeni(puntoId) {
      const container = document.getElementById('beniContainer');
      container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border" role="status"></div></div>';

      try {
        // ✅ Endpoint corretto con /auth/
        const response = await fetch(`/punti/${puntoId}/beni`);
        if (!response.ok) throw new Error('Errore nel caricamento dei beni');
        
        const beni = await response.json();
        if (beni.length === 0) {
          container.innerHTML = '<div class="col-12 alert alert-info">Nessun bene disponibile in questo punto.</div>';
          return;
        }

        container.innerHTML = beni.map(bene => `
          <div class="col-md-4">
            <div class="card bene-card" onclick="selezionaBene(${JSON.stringify(bene).replace(/"/g, '&quot;')})">
              <div class="card-body">
                <h6 class="card-title">${bene.nome}</h6>
                <p class="card-text text-muted small">Quantità: ${bene.quantita_disponibile || 'Non specificata'}</p>
                <p class="card-text"><small class="text-muted">${bene.categoria}</small></p>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Errore caricamento beni:', error);
        container.innerHTML = '<div class="col-12 alert alert-danger">Errore nel caricamento dei beni. Riprova più tardi.</div>';
        showError('errorMessage', 'Impossibile caricare i beni. Riprova più tardi.');
      }
    }

    /**
     * Carica gli slot orari per il bene selezionato
     */
    async function caricaSlot(puntoId, beneId) {
      const container = document.getElementById('slotContainer');
      container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border" role="status"></div></div>';

      try {
        // ✅ Endpoint corretto 
        const response = await fetch(`/punti/${puntoId}/beni/${beneId}/slot`);
        if (!response.ok) throw new Error('Errore nel caricamento degli slot');
        
        const slot = await response.json();
        if (slot.length === 0) {
          container.innerHTML = '<div class="col-12 alert alert-info">Nessuno slot disponibile per questo bene.</div>';
          return;
        }

        container.innerHTML = slot.map(s => `
          <div class="col-md-4">
            <div class="card slot-card" onclick="selezionaSlot('${s.orario_inizio}', '${s.orario_fine}')">
              <div class="card-body text-center">
                <h6 class="card-title">${s.orario_inizio} - ${s.orario_fine}</h6>
                <span class="slot-badge bg-success">Disponibile</span>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Errore caricamento slot:', error);
        container.innerHTML = '<div class="col-12 alert alert-danger">Errore nel caricamento degli slot. Riprova più tardi.</div>';
        showError('errorMessage', 'Impossibile caricare gli slot. Riprova più tardi.');
      }
    }

    /**
     * Seleziona un bene
     */
    function selezionaBene(bene) {
      beneSelezionato = bene;
      goToStep(2);
      caricaSlot(puntoId, bene.id);
    }

    /**
     * Seleziona uno slot
     */
    function selezionaSlot(inizio, fine) {
      slotSelezionato = { inizio, fine };
      document.querySelectorAll('.slot-card').forEach(card => card.classList.remove('border', 'border-primary'));
      event.currentTarget.classList.add('border', 'border-primary');
    }

    /**
     * Cambia step
     */
    function goToStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');
    }

    /**
     * Conferma la prenotazione
     */
    async function confermaPrenotazione() {
      if (!beneSelezionato || !slotSelezionato) {
        showError('errorMessage', 'Seleziona prima un bene e uno slot orario');
        return;
      }

      const confermaBtn = document.getElementById('confermaPrenotazioneBtn');
      confermaBtn.disabled = true;
      confermaBtn.textContent = 'Conferma in corso...';

      try {
        // ✅ Endpoint corretto con /auth/
        const response = await fetch('/prenotazione', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            punto_id: puntoId,
            bene_id: beneSelezionato.id,
            slot_orario: `${slotSelezionato.inizio}-${slotSelezionato.fine}`
          })
        });

        const data = await response.json();
        if (response.ok && data.codice_prenotazione) {
          // Mostra QR code
          document.getElementById('qrCodePlaceholder').innerHTML = `
            <div class="mb-2">Codice prenotazione:</div>
            <div class="fw-bold">${data.codice_prenotazione}</div>
            <div class="mt-2 small text-muted">Presenta questo codice al punto di distribuzione</div>
          `;
          goToStep(3);
        } else {
          showError('errorMessage', data.error || 'Errore durante la prenotazione');
        }
      } catch (error) {
        console.error('Errore prenotazione:', error);
        showError('errorMessage', 'Errore di connessione al server. Riprova più tardi.');
      } finally {
        confermaBtn.disabled = false;
        confermaBtn.textContent = 'Conferma Prenotazione';
      }
    }

    // Inizializza la pagina
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof updateAuthButtons === 'function') updateAuthButtons();
      
      puntoId = getPointIdFromUrl();
      if (!puntoId) {
        showError('errorMessage', 'ID punto non valido');
        setTimeout(() => window.location.href = 'home.html', 2000);
        return;
      }
      
      caricaBeni(puntoId);
      
      // Gestione pulsante conferma
      document.getElementById('confermaPrenotazioneBtn').addEventListener('click', confermaPrenotazione);
    });
  </script>
  <!-- ✅ Chatbot integrato -->
  <script src="../chatbot/js/loader.js"></script>
</body>
</html>
