<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Prenota Pacco - Map4Aid</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='static/css/style.css') }}">
  <style>
    .step { display: none; }
    .step.active { display: block; }
    .bene-card { cursor: pointer; transition: all 0.2s; }
    .bene-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .bene-card.selected { border: 2px solid #28a745; }
    .qr-placeholder { background-color: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; padding: 2rem; text-align: center; }
    .pacco-contenuto { font-size: 0.9em; }
    .pacco-contenuto li { padding: 0.15rem 0; }
  </style>
</head>
<body class="bg-light">
  <!-- Header dinamico -->
  <header class="header-bg text-white p-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <img src="{{ url_for('static', filename='static/imgs/logo.png') }}" alt="Logo Map4Aid" width="60" height="60" class="me-3 rounded-circle">
      <h1 class="h4 mb-0 ms-3">MAP4AID</h1>
    </div>
    <div class="d-flex gap-2" id="auth-buttons"></div>
  </header>

  <div class="container mt-4">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">Prenotazione pacco</h4>
          </div>
          <div class="card-body">
            <!-- Step 1: Selezione pacco -->
            <div id="step1" class="step active">
              <h5 class="mb-3">Beni disponibili per la prenotazione</h5>
              <div id="pacchiContainer" class="row g-3">
                <!-- I pacchi verranno caricati qui -->
              </div>
              <div id="errorMessage" class="mt-3 text-danger" style="display:none;"></div>
            </div>

            <!-- Step 2: Conferma prenotazione -->
            <div id="step2" class="step">
              <h5 class="mb-3">Conferma la tua prenotazione</h5>
              <div class="card mb-3">
                <div class="card-body">
                  <h6 class="card-title" id="riepilogoPaccoNome"></h6>
                  <p class="card-text text-muted" id="riepilogoPaccoDescrizione"></p>
                </div>
              </div>
              <div class="mt-3">
                <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Indietro</button>
                <button type="button" class="btn btn-success" id="confermaPrenotazioneBtn">Conferma Prenotazione</button>
              </div>
              <div id="errorMessageStep2" class="mt-3 text-danger" style="display:none;"></div>
            </div>

            <!-- Step 3: QR Code -->
            <div id="step3" class="step">
              <h5 class="mb-3">Prenotazione confermata!</h5>
              <div class="qr-placeholder">
                <div class="mb-3">
                  <strong>Ti è stata inviata un'email di conferma della tua prenotazione</strong>
                </div>
                <div id="qrCodePlaceholder" class="text-muted">
                  Il QR code verrà generato e mandato alla tua email
                </div>
                <div class="mt-3">
                </div>
              </div>
              <div class="mt-3">
                <a href="/" class="btn btn-primary">Torna alla home</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-3 mt-4">
    <p>&copy; 2026 Map4Aid - Progetto Universitario</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='static/js/auth.js') }}"></script>
  <script>
    // Dati globali
    let puntoId = null;
    let paccoSelezionato = null;

    // Protezione: solo utenti loggati
    if (!sessionStorage.getItem('isLoggedIn')) {
      // Nota: assicurati che la funzione showError sia definita in auth.js
      console.error('Login richiesto');
      setTimeout(() => window.location.href = '/login', 2000);
    }

    function getPointIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    /**
     * Carica sia i pacchi che i beni singoli
     */
    async function caricaPacchi(puntoId) {
      const container = document.getElementById('pacchiContainer');
      container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border" role="status"></div></div>';

      try {
        const response = await fetch(`/auth/punti/${puntoId}/beni`);
        if (!response.ok) throw new Error('Errore nel caricamento');

        const tuttiIBeni = await response.json();
        console.log("Dati ricevuti:", tuttiIBeni); // Per debug

        if (!tuttiIBeni || tuttiIBeni.length === 0) {
          container.innerHTML = '<div class="col-12 alert alert-info">Nessun bene o pacco disponibile in questo punto.</div>';
          return;
        }

        container.innerHTML = tuttiIBeni.map(item => {
          const isPacco = item.tipo === 'pacco';
          // Usiamo una stringa JSON sicura per l'attributo onclick
          const itemJSON = JSON.stringify(item).replace(/"/g, '&quot;');

          return `
            <div class="col-md-6">
              <div class="card bene-card ${isPacco ? 'border-primary' : ''}" onclick="selezionaBene(${itemJSON})">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0">${item.nome}</h6>
                    <span class="badge ${isPacco ? 'bg-primary' : 'bg-secondary'}">
                      ${isPacco ? 'Pacco' : (item.sottocategoria || 'Bene')}
                    </span>
                  </div>

                  ${isPacco ? `
                    <p class="card-text text-muted small mb-2">Contenuto standard:</p>
                    <ul class="pacco-contenuto list-unstyled mb-0">
                      <li>&#8226; Pasta, Pane, Acqua, Carne, Pesce, Verdura</li>
                    </ul>
                  ` : `
                    <p class="card-text text-muted small">Quantità disponibile: ${item.quantita || 1}</p>
                  `}
                </div>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Errore caricamento:', error);
        container.innerHTML = '<div class="col-12 alert alert-danger">Errore nel caricamento dei dati dal server.</div>';
      }
    }

    function selezionaBene(item) {
      paccoSelezionato = item;
      document.getElementById('riepilogoPaccoNome').textContent = item.nome;

      const descrizione = item.tipo === 'pacco'
        ? 'Riceverai un pacco alimentare completo contenente i beni di prima necessità.'
        : `Stai prenotando il seguente bene singolo: ${item.nome}.`;

      document.getElementById('riepilogoPaccoDescrizione').textContent = descrizione;
      goToStep(2);
    }

    function goToStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');
    }

    async function confermaPrenotazione() {
      if (!paccoSelezionato) return;

      const confermaBtn = document.getElementById('confermaPrenotazioneBtn');
      const errorMsg = document.getElementById('errorMessageStep2');

      confermaBtn.disabled = true;
      confermaBtn.textContent = 'Inviando...';
      errorMsg.style.display = 'none';

      try {
        const formData = new FormData();
        formData.append('id_punto_bisogno', puntoId);
        formData.append('id_bene', paccoSelezionato.id);

        // Conversione booleana per il backend Flask
        const isPacco = paccoSelezionato.tipo === 'pacco' ? 'True' : 'False';
        formData.append('is_pacco', isPacco);

        // Se il bene singolo è un medicinale (gestito tramite sottocategoria)
        const isMedicinale = (paccoSelezionato.tipo === 'medicinale') ? 'True' : 'False';
        formData.append('is_medicinale', isMedicinale);

        const response = await fetch('/auth/prenotazione', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        if (response.ok) {
          document.getElementById('qrCodePlaceholder').innerHTML = `
            <div class="mb-2 text-success">Prenotazione confermata con successo!</div>
            <div class="h4 fw-bold">${data.codice || 'QR-CODE inviato alla tua email'}</div>
            <div class="small text-muted">Mostra questo codice al punto di ritiro.</div>
          `;
          goToStep(3);
        } else {
          errorMsg.textContent = data.error || 'Errore durante la prenotazione';
          errorMsg.style.display = 'block';
        }
      } catch (error) {
        console.error('Errore invio:', error);
        errorMsg.textContent = 'Errore di connessione al server.';
        errorMsg.style.display = 'block';
      } finally {
        confermaBtn.disabled = false;
        confermaBtn.textContent = 'Conferma Prenotazione';
      }
    }

    // Inizializzazione
    document.addEventListener('DOMContentLoaded', () => {
      puntoId = getPointIdFromUrl();
      if (!puntoId) {
        alert('ID punto non trovato nell\'URL');
        return;
      }
      caricaPacchi(puntoId);
      document.getElementById('confermaPrenotazioneBtn').addEventListener('click', confermaPrenotazione);
    });
  </script>
  <!-- Chatbot integrato -->
  <script src="../chatbot/js/loader.js"></script>
</body>
</html>
