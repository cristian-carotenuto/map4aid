<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Prenota Pacco - Map4Aid</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    .step { display: none; }
    .step.active { display: block; }
    .bene-card { cursor: pointer; transition: all 0.2s; }
    .bene-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .bene-card.selected { border: 2px solid #28a745; }
    .qr-placeholder { background-color: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; padding: 2rem; text-align: center; }
    .pacco-contenuto { font-size: 0.9em; }
    .pacco-contenuto li { padding: 0.15rem 0; }
  </style>
</head>
<body class="bg-light">
  <!-- Header dinamico -->
  <header class="header-bg text-white p-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <img src="{{ url_for('static', filename='imgs/logo.png') }}" alt="Logo Map4Aid" width="60" height="60" class="me-3 rounded-circle">
      <h1 class="h4 mb-0 ms-3">MAP4AID</h1>
    </div>
    <div class="d-flex gap-2" id="auth-buttons"></div>
  </header>

  <div class="container mt-4">
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">Prenotazione pacco</h4>
          </div>
          <div class="card-body">
            <!-- Step 1: Selezione pacco -->
            <div id="step1" class="step active">
              <h5 class="mb-3">Pacchi disponibili per la prenotazione</h5>
              <div id="pacchiContainer" class="row g-3">
                <!-- I pacchi verranno caricati qui -->
              </div>
              <div id="errorMessage" class="mt-3 text-danger" style="display:none;"></div>
            </div>

            <!-- Step 2: Conferma prenotazione -->
            <div id="step2" class="step">
              <h5 class="mb-3">Conferma la tua prenotazione</h5>
              <div class="card mb-3">
                <div class="card-body">
                  <h6 class="card-title" id="riepilogoPaccoNome"></h6>
                  <p class="card-text text-muted" id="riepilogoPaccoDescrizione"></p>
                </div>
              </div>
              <div class="mt-3">
                <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Indietro</button>
                <button type="button" class="btn btn-success" id="confermaPrenotazioneBtn">Conferma Prenotazione</button>
              </div>
              <div id="errorMessageStep2" class="mt-3 text-danger" style="display:none;"></div>
            </div>

            <!-- Step 3: QR Code -->
            <div id="step3" class="step">
              <h5 class="mb-3">Prenotazione confermata!</h5>
              <div class="qr-placeholder">
                <div class="mb-3">
                  <strong>QR Code della tua prenotazione</strong>
                </div>
                <div id="qrCodePlaceholder" class="text-muted">
                  Il QR code verrà generato dal server
                </div>
                <div class="mt-3">
                  <button class="btn btn-success" onclick="window.print()">Stampa QR Code</button>
                </div>
              </div>
              <div class="mt-3">
                <a href="/" class="btn btn-primary">Torna alla home</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-3 mt-4">
    <p>&copy; 2026 Map4Aid - Progetto Universitario</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
  <script>
    // Dati globali
    let puntoId = null;
    let paccoSelezionato = null;

    // Protezione: solo utenti loggati
    if (!sessionStorage.getItem('isLoggedIn')) {
      showError('errorMessage', 'Devi effettuare il login per prenotare un pacco');
      setTimeout(() => window.location.href = 'login.html', 2000);
      setTimeout(() => window.location.href = '/login', 2000);
    }

    /**
     * Estrae l'ID del punto dall'URL
     */
    function getPointIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    /**
     * Carica i pacchi disponibili per il punto.
     * L'endpoint restituisce tutti i beni + il pacco (tipo "pacco") se è assemblabile.
     * Filtriamo lato client per mostrare solo i pacchi.
     */
    async function caricaPacchi(puntoId) {
      const container = document.getElementById('pacchiContainer');
      container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border" role="status"></div></div>';

      try {
        const response = await fetch(`/auth/punti/${puntoId}/beni`);
        if (!response.ok) throw new Error('Errore nel caricamento');

        const beni = await response.json();
        const pacchi = beni.filter(b => b.tipo === 'pacco');

        if (pacchi.length === 0) {
          container.innerHTML = '<div class="col-12 alert alert-info">Nessun pacco disponibile in questo punto al momento. I pacchi vengono resi disponibili quando tutte le categorie alimentari (Pasta, Pane, Acqua, Carne, Pesce, Verdura) sono presenti.</div>';
          return;
        }

        container.innerHTML = pacchi.map(pacco => `
          <div class="col-md-6">
            <div class="card bene-card" onclick="selezionaPacco(${JSON.stringify(pacco).replace(/"/g, '&quot;')})">
              <div class="card-body">
                <h6 class="card-title">${pacco.nome}</h6>
                <p class="card-text text-muted small mb-2">Contiene:</p>
                <ul class="pacco-contenuto list-unstyled mb-0">
                  <li>&#8226; Pasta</li>
                  <li>&#8226; Pane</li>
                  <li>&#8226; Acqua</li>
                  <li>&#8226; Carne</li>
                  <li>&#8226; Pesce</li>
                  <li>&#8226; Verdura</li>
                </ul>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Errore caricamento pacchi:', error);
        container.innerHTML = '<div class="col-12 alert alert-danger">Errore nel caricamento dei pacchi. Riprova più tardi.</div>';
        showError('errorMessage', 'Impossibile caricare i pacchi. Riprova più tardi.');
      }
    }

    /**
     * Seleziona un pacco e mostra il riepilogo
     */
    function selezionaPacco(pacco) {
      paccoSelezionato = pacco;
      document.getElementById('riepilogoPaccoNome').textContent = pacco.nome;
      document.getElementById('riepilogoPaccoDescrizione').textContent =
        'Il pacco contiene: Pasta, Pane, Acqua, Carne, Pesce, Verdura. Conferma per completare la prenotazione.';
      goToStep(2);
    }

    /**
     * Cambia step
     */
    function goToStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');
    }

    /**
     * Conferma la prenotazione del pacco
     */
    async function confermaPrenotazione() {
      if (!paccoSelezionato) {
        showError('errorMessageStep2', 'Seleziona prima un pacco');
        return;
      }

      const confermaBtn = document.getElementById('confermaPrenotazioneBtn');
      confermaBtn.disabled = true;
      confermaBtn.textContent = 'Conferma in corso...';

      try {
        const formData = new FormData();
        formData.append('id_punto_bisogno', puntoId);
        formData.append('id_bene', paccoSelezionato.id);
        formData.append('is_pacco', 'True');
        formData.append('is_medicinale', 'False');

        const response = await fetch('/auth/prenotazione', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        if (response.ok && data.message) {
          document.getElementById('qrCodePlaceholder').innerHTML = `
            <div class="mb-2">Prenotazione confermata!</div>
            <div class="fw-bold">${data.message}</div>
            <div class="mt-2 small text-muted">Controlla la tua email per i dettagli</div>
          `;
          goToStep(3);
        } else {
          showError('errorMessageStep2', data.error || 'Errore durante la prenotazione');
        }
      } catch (error) {
        console.error('Errore prenotazione:', error);
        showError('errorMessageStep2', 'Errore di connessione al server. Riprova più tardi.');
      } finally {
        confermaBtn.disabled = false;
        confermaBtn.textContent = 'Conferma Prenotazione';
      }
    }

    // Inizializza la pagina
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof updateAuthButtons === 'function') updateAuthButtons();

      puntoId = getPointIdFromUrl();
      if (!puntoId) {
        showError('errorMessage', 'ID punto non valido');
        setTimeout(() => window.location.href = '/', 2000);
        return;
      }

      caricaPacchi(puntoId);

      // Gestione pulsante conferma
      document.getElementById('confermaPrenotazioneBtn').addEventListener('click', confermaPrenotazione);
    });
  </script>
  <!-- Chatbot integrato -->
  <script src="../chatbot/js/loader.js"></script>
</body>
</html>
