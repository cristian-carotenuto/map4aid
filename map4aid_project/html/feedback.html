<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Feedback - Map4Aid</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; gap: 0.25rem; }
    .star-rating input { display: none; }
    .star-rating label { font-size: 2rem; color: #ddd; cursor: pointer; transition: color 0.2s; }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label { color: #ffc107; }
  </style>
</head>
<body class="bg-light">
  <!-- Header dinamico -->
  <header class="header-bg text-white p-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <img src="../imgs/logo.png" alt="Logo Map4Aid" width="60" height="60" class="me-3 rounded-circle">
      <h1 class="h4 mb-0 ms-3">MAP4AID</h1>
    </div>
    <div class="d-flex gap-2" id="auth-buttons"></div>
  </header>

  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="text-center">Lascia un Feedback</h3>
          </div>
          <div class="card-body">
            <p class="text-muted">
              Seleziona una prenotazione ritirata e lascia la tua valutazione.
              La recensione testuale Ã¨ facoltativa.
            </p>

            <form id="feedbackForm">
              <!-- Selezione prenotazione -->
              <div class="mb-3">
                <label for="prenotazione" class="form-label">Prenotazione</label>
                <select class="form-select" id="prenotazione" name="prenotazione" required>
                  <option value="" disabled selected>Caricamento...</option>
                </select>
              </div>

              <!-- Valutazione a stelle -->
              <div class="mb-3">
                <label class="form-label">Valutazione</label>
                <div class="star-rating">
                  <input type="radio" id="star5" name="valutazione" value="5"><label for="star5">&#9733;</label>
                  <input type="radio" id="star4" name="valutazione" value="4"><label for="star4">&#9733;</label>
                  <input type="radio" id="star3" name="valutazione" value="3"><label for="star3">&#9733;</label>
                  <input type="radio" id="star2" name="valutazione" value="2"><label for="star2">&#9733;</label>
                  <input type="radio" id="star1" name="valutazione" value="1"><label for="star1">&#9733;</label>
                </div>
              </div>

              <!-- Recensione (facoltativa) -->
              <div class="mb-3">
                <label for="recensione" class="form-label">Recensione <small class="text-muted">(facoltativa)</small></label>
                <textarea class="form-control" id="recensione" name="recensione" rows="4" placeholder="Scrivi qui la tua esperienza..."></textarea>
              </div>

              <button type="submit" class="btn btn-success w-100" id="submitBtn">Invia Feedback</button>
            </form>

            <div id="errorMessage" class="mt-3 text-danger" style="display:none;"></div>
            <div id="successMessage" class="mt-3 text-success" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-3 mt-4">
    <p>&copy; 2026 Map4Aid - Progetto Universitario</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    // Controllo autenticazione
    if (!sessionStorage.getItem('isLoggedIn')) {
      showError('errorMessage', 'Accesso riservato agli utenti registrati');
      setTimeout(() => window.location.href = 'login.html', 2000);
    }

    /**
     * Carica le prenotazioni ritirate dell'utente nel select
     */
    async function caricaPrenotazioniRitirate() {
      const select = document.getElementById('prenotazione');
      try {
        const response = await fetch('/auth/prenotazioni');
        if (!response.ok) throw new Error('Errore nel caricamento');
        const prenotazioni = await response.json();
        const ritirate = prenotazioni.filter(p => p.stato === 'ritirata');

        select.innerHTML = '';

        if (ritirate.length === 0) {
          select.innerHTML = '<option value="" disabled selected>Nessuna prenotazione ritirata disponibile</option>';
          document.getElementById('submitBtn').disabled = true;
          return;
        }

        select.innerHTML = '<option value="" disabled selected>Seleziona una prenotazione...</option>';
        ritirate.forEach(p => {
          const option = document.createElement('option');
          option.value = p.id;
          option.textContent = `#${p.id} - ${p.bene} (${p.data})`;
          select.appendChild(option);
        });
      } catch (error) {
        select.innerHTML = '<option value="" disabled selected>Errore nel caricamento</option>';
        showError('errorMessage', 'Impossibile caricare le prenotazioni.');
      }
    }

    /**
     * Invio del feedback
     */
    document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const idPrenotazione = parseInt(document.getElementById('prenotazione').value);
      const valutazioneEl = document.querySelector('input[name="valutazione"]:checked');
      const recensione = document.getElementById('recensione').value.trim() || null;

      if (!idPrenotazione) {
        showError('errorMessage', 'Seleziona una prenotazione');
        return;
      }
      if (!valutazioneEl) {
        showError('errorMessage', 'Seleziona una valutazione (da 1 a 5 stelle)');
        return;
      }

      const valutazione = parseInt(valutazioneEl.value);
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Invio in corso...';

      try {
        const response = await fetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_email: getUserEmail(),
            id_prenotazione: idPrenotazione,
            valutazione: valutazione,
            recensione: recensione
          })
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess('successMessage', 'Feedback inviato con successo! Grazie per la tua valutazione.');
          document.getElementById('feedbackForm').reset();
          // Ricarica le prenotazioni per rimuovere quella appena recensita
          await caricaPrenotazioniRitirate();
        } else {
          showError('errorMessage', data.error || 'Errore durante l\'invio del feedback');
        }
      } catch (error) {
        showError('errorMessage', 'Errore di connessione al server');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Invia Feedback';
      }
    });

    document.addEventListener('DOMContentLoaded', caricaPrenotazioniRitirate);
  </script>
  <!-- Chatbot integrato -->
  <script src="../chatbot/js/loader.js"></script>
</body>
</html>
