<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Storico Prenotazioni - Map4Aid</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    .status-badge { font-size: 0.85em; padding: 0.4em 0.6em; }
    .prenotazione-card { border-left: 4px solid #28a745; transition: transform 0.2s; }
    .prenotazione-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="bg-light">
  <!-- Header dinamico -->
  <header class="header-bg text-white p-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <img src="{{ url_for('static', filename='imgs/logo.png') }}" alt="Logo Map4Aid" width="60" height="60" class="me-3 rounded-circle">
      <h1 class="h4 mb-0 ms-3">MAP4AID</h1>
    </div>
    <div class="d-flex gap-2" id="auth-buttons"></div>
  </header>

  <div class="container mt-5">
    <div class="row">
      <!-- Sidebar coerente con profilo.html e storico-donazioni.html -->
      <div class="col-md-3">
        <div class="list-group">
          <a href="/profilo" class="list-group-item list-group-item-action">Profilo</a>
          <a href="/storico-prenotazioni" class="list-group-item list-group-item-action active">Storico Prenotazioni</a>
          <a href="/storico-donazioni" class="list-group-item list-group-item-action">Storico Donazioni</a>
        </div>
      </div>

      <div class="col-md-9">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="mb-0 text-center flex-grow-1">Le mie prenotazioni</h3>
            <div class="d-flex gap-2 align-items-center">
              <span class="badge bg-primary" id="conteggioPrenotazioni">Caricamento...</span>
              <a href="/auth/storico_pdf" class="btn btn-outline-primary btn-sm" target="_blank">Scarica PDF</a>
            </div>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="filtroStato" class="form-label">Filtra per stato</label>
              <select id="filtroStato" class="form-select">
                <option value="">Tutti gli stati</option>
                <option value="confermata">Confermate</option>
                <option value="in_attesa">In attesa</option>
                <option value="ritirata">Ritirate</option>
                <option value="scaduta">Scadute</option>
              </select>
            </div>
            <div id="listaPrenotazioni"></div>
            <div id="errorMessage" class="mt-3 text-danger" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-3 mt-4">
    <p>&copy; 2026 Map4Aid - Progetto Universitario</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
  <script>
    if (!sessionStorage.getItem('isLoggedIn')) {
      showError('errorMessage', 'Accesso riservato agli utenti registrati');
      setTimeout(() => window.location.href = '/login', 2000);
    }

    function getBadgeClass(stato) {
      switch (stato) {
        case 'confermata': return 'bg-success';
        case 'in_attesa': return 'bg-warning text-dark';
        case 'ritirata': return 'bg-info';
        case 'scaduta': return 'bg-secondary';
        default: return 'bg-light text-dark';
      }
    }

    function getStatoItaliano(stato) {
      return { 'confermata':'Confermata','in_attesa':'In attesa','ritirata':'Ritirata','scaduta':'Scaduta' }[stato] || stato;
    }

    function generaCardPrenotazione(p) {
      return `
        <div class="card mb-3 prenotazione-card"><div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="card-title mb-1">Prenotazione #${p.id}</h6>
              <p class="card-text mb-1"><strong>${p.bene}</strong> (x${p.quantita || 1})</p>
              <p class="card-text text-muted small mb-1">${p.punto} - ${p.indirizzo || 'Indirizzo non disponibile'}</p>
              <p class="card-text small mb-0">${p.data} &bull; ${p.ora}</p>
            </div>
            <span class="status-badge ${getBadgeClass(p.stato)}">${getStatoItaliano(p.stato)}</span>
          </div>
        </div></div>`;
    }

    async function caricaPrenotazioni(filtro = '') {
      const container = document.getElementById('listaPrenotazioni');
      const conteggio = document.getElementById('conteggioPrenotazioni');
      container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
      try {
        const response = await fetch('/auth/prenotazioni');
        if (!response.ok) throw new Error('Errore');
        const prenotazioni = await response.json();
        conteggio.textContent = `${prenotazioni.length} prenotazioni`;
        if (prenotazioni.length === 0) { container.innerHTML = '<div class="alert alert-info">Non hai ancora effettuato prenotazioni.</div>'; return; }
        let filtrate = filtro === '' ? prenotazioni : prenotazioni.filter(p => p.stato === filtro);
        if (filtrate.length === 0) { container.innerHTML = '<div class="alert alert-info">Nessuna prenotazione con questo stato.</div>'; return; }
        container.innerHTML = filtrate.map(generaCardPrenotazione).join('');
      } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">Errore nel caricamento. Riprova pi√π tardi.</div>';
        showError('errorMessage', 'Impossibile caricare lo storico.');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      caricaPrenotazioni();
      document.getElementById('filtroStato').addEventListener('change', (e) => caricaPrenotazioni(e.target.value));
    });
  </script>
  <script src="../chatbot/js/loader.js"></script>
</body>
</html>
