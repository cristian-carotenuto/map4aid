<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <title>Profilo - Map4Aid</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='static/css/style.css') }}">
</head>

<body class="bg-light">
  <!-- Header dinamico -->
  <header class="header-bg text-white p-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <img src="{{ url_for('static', filename='static/imgs/logo.png') }}" alt="Logo Map4Aid" width="60" height="60"
        class="me-3 rounded-circle">
      <h1 class="h4 mb-0 ms-3">MAP4AID</h1>
    </div>
    <div class="d-flex gap-2" id="auth-buttons"></div>
  </header>

  <div class="container mt-5">
    <div class="row">
      <!-- Sidebar dinamica per ruolo -->
      <div class="col-md-3">
        <div id="sidebar" class="list-group">
          <a href="/profilo" class="list-group-item list-group-item-action active">Profilo</a>
          <a href="/storico-prenotazioni" class="list-group-item list-group-item-action">Storico Prenotazioni</a>
          <a href="/storico-donazioni" class="list-group-item list-group-item-action">Storico Donazioni</a>
        </div>
      </div>
      <!-- Contenuto principale -->
      <div class="col-md-9">
        <div class="card">
          <div class="card-header">
            <h3 class="text-center">Il mio profilo</h3>
          </div>
          <div class="card-body">
            <div id="profiloContent" style="display:none;">
              <table class="table table-borderless" id="tabellaProFilo"></table>
              <button id="btnModifica" class="btn btn-primary mt-3">Modifica profilo</button>
            </div>
            <div id="loadingMessage" class="text-center">Caricamento profilo...</div>
            <div id="errorMessage" class="mt-3 text-danger" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Modifica Profilo -->
  <div class="modal fade" id="modalModifica" tabindex="-1" aria-labelledby="modalModificaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalModificaLabel">Modifica profilo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <div id="modificaMsg" class="mb-3" style="display:none;"></div>
          <form id="modificaForm" onsubmit="return false;">
            <div id="campiModifica"></div>
            <!-- Sezione email separata -->
            <hr>
            <div class="mb-3">
              <label class="form-label fw-bold">Email</label>
              <div class="input-group">
                <input type="email" class="form-control" id="emailAttuale" readonly
                  style="background-color: #e9ecef;">
                <button type="button" class="btn btn-outline-secondary" id="btnCambiaEmail">Cambia email</button>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-success" id="btnSalvaModifiche">Salva modifiche</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal OTP Cambio Email -->
  <div class="modal fade" id="modalOtpEmail" tabindex="-1" aria-labelledby="modalOtpEmailLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalOtpEmailLabel">Verifica cambio email</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            Per motivi di sicurezza, il cambio email richiede una verifica.
            Inserisci la nuova email e ti invieremo un codice OTP a quell'indirizzo per confermare che sia tuo.
          </div>
          <div id="otpEmailMsg" class="mb-3" style="display:none;"></div>
          <form id="formNuovaEmail" onsubmit="return false;">
            <div class="mb-3" id="stepNuovaEmail">
              <label class="form-label">Nuova email</label>
              <input type="email" class="form-control" id="inputNuovaEmail" required>
              <button type="button" class="btn btn-primary mt-2" id="btnInviaOtpEmail">Invia codice OTP</button>
            </div>
            <div class="mb-3" id="stepOtp" style="display:none;">
              <label class="form-label">Codice OTP ricevuto</label>
              <input type="text" class="form-control" id="inputOtpEmail" maxlength="4"
                placeholder="Inserisci il codice a 4 cifre">
              <button type="button" class="btn btn-success mt-2" id="btnConfermaOtpEmail">Conferma</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-3 mt-4">
    <p>&copy; 2026 Map4Aid - Progetto Universitario</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='static/js/auth.js') }}"></script>
  <script>
    // Dati profilo caricati dal server
    let profiloData = null;

    // Protezione: solo utenti loggati
    if (!isLoggedIn()) {
      showError('errorMessage', 'Devi effettuare il login per accedere al profilo');
      setTimeout(() => window.location.href = '/login', 2000);
    } else {
      // Carica dati profilo
      fetch('/auth/profilo')
        .then(response => {
          if (!response.ok) throw new Error('Errore nel caricamento del profilo');
          return response.json();
        })
        .then(data => {
          profiloData = data;
          const tipo = data.tipo;
          const tabella = document.getElementById('tabellaProFilo');
          const sidebar = document.getElementById('sidebar');

          // Riga helper
          function riga(etichetta, valore) {
            return `<tr><th style="width:35%">${etichetta}</th><td>${valore || '\u2014'}</td></tr>`;
          }

          // === SIDEBAR per ruolo ===
          if (tipo === 'beneficiario') {
            sidebar.innerHTML = `
              <a href="/profilo" class="list-group-item list-group-item-action active">Profilo</a>
              <a href="/storico-prenotazioni" class="list-group-item list-group-item-action">Storico Prenotazioni</a>
              <a href="/storico-donazioni" class="list-group-item list-group-item-action">Storico Donazioni</a>
            `;
          } else if (tipo === 'donatore') {
            sidebar.innerHTML = `
              <a href="/profilo" class="list-group-item list-group-item-action active">Profilo</a>
              <a href="/storico-donazioni" class="list-group-item list-group-item-action">Storico Donazioni</a>
            `;
          } else if (tipo === 'ente_erogatore') {
            sidebar.innerHTML = `
              <a href="/profilo" class="list-group-item list-group-item-action active">Profilo</a>
              <a href="/ente-punti" class="list-group-item list-group-item-action">I miei punti</a>
            `;
          }

          // === CAMPI per ruolo ===
          let righe = riga('Email', data.email);
          righe += riga('Tipo account', data.tipo);

          if (tipo === 'beneficiario') {
            righe += riga('Nome', data.nome);
            righe += riga('Cognome', data.cognome);
            righe += riga('Data di nascita', data.data_nascita);
            righe += riga('Allergeni', data.allergeni);
            righe += riga('Patologie', data.patologie);
          } else if (tipo === 'donatore') {
            if (data.categoria === 'privato') {
              righe += riga('Nome', data.nome);
              righe += riga('Cognome', data.cognome);
            } else {
              righe += riga('Nome attivit\u00e0', data.nome_attivita);
              righe += riga('Partita IVA', data.partita_iva);
              righe += riga('Indirizzo sede', data.indirizzo_sede);
            }
            righe += riga('Categoria', data.categoria);
          } else if (tipo === 'ente_erogatore') {
            righe += riga('Organizzazione', data.nome_organizzazione);
            righe += riga('Tipologia ente', data.tipologia_ente);
            righe += riga('Indirizzo sede', data.indirizzo_sede);
            righe += riga('IBAN', data.iban);
          }

          tabella.innerHTML = righe;
          document.getElementById('loadingMessage').style.display = 'none';
          document.getElementById('profiloContent').style.display = 'block';
        })
        .catch(() => {
          document.getElementById('loadingMessage').style.display = 'none';
          showError('errorMessage', 'Impossibile caricare il profilo. Riprova pi\u00f9 tardi.');
        });
    }

    // === APERTURA MODAL MODIFICA ===
    document.getElementById('btnModifica').addEventListener('click', () => {
      if (!profiloData) return;
      const d = profiloData;
      const tipo = d.tipo;
      const container = document.getElementById('campiModifica');

      // Helper: campo editabile
      function campo(label, name, value) {
        return `<div class="mb-3">
          <label class="form-label">${label}</label>
          <input type="text" class="form-control" name="${name}" value="${value || ''}">
        </div>`;
      }
      // Helper: campo readonly (protetto)
      function campoReadonly(label, value) {
        return `<div class="mb-3">
          <label class="form-label">${label}</label>
          <input type="text" class="form-control" value="${value || '\u2014'}" readonly style="background-color: #e9ecef;">
        </div>`;
      }

      let html = '';

      if (tipo === 'beneficiario') {
        html += campo('Nome', 'nome', d.nome);
        html += campo('Cognome', 'cognome', d.cognome);
        html += campoReadonly('Data di nascita', d.data_nascita);
        html += campo('Allergeni', 'allergeni', d.allergeni);
        html += campo('Patologie', 'patologie', d.patologie);
      } else if (tipo === 'donatore') {
        if (d.categoria === 'privato') {
          html += campo('Nome', 'nome', d.nome);
          html += campo('Cognome', 'cognome', d.cognome);
        } else {
          html += campo('Nome attivit\u00e0', 'nome_attivita', d.nome_attivita);
          html += campoReadonly('Partita IVA', d.partita_iva);
          html += campo('Indirizzo sede', 'indirizzo_sede', d.indirizzo_sede);
        }
        html += campoReadonly('Categoria', d.categoria);
      } else if (tipo === 'ente_erogatore') {
        html += campo('Organizzazione', 'nome_organizzazione', d.nome_organizzazione);
        html += campoReadonly('Tipologia ente', d.tipologia_ente);
        html += campo('Indirizzo sede', 'indirizzo_sede', d.indirizzo_sede);
        html += campo('IBAN', 'iban', d.iban);
      }

      container.innerHTML = html;
      document.getElementById('emailAttuale').value = d.email;
      document.getElementById('modificaMsg').style.display = 'none';

      const modal = new bootstrap.Modal(document.getElementById('modalModifica'));
      modal.show();
    });

    // === SALVA MODIFICHE (senza email) ===
    document.getElementById('btnSalvaModifiche').addEventListener('click', () => {
      const form = document.getElementById('modificaForm');
      const formData = new FormData(form);
      // Rimuovi email dal salvataggio normale
      formData.delete('email');

      fetch('/auth/modifica_profilo', {
        method: 'POST',
        body: formData
      })
        .then(r => r.json())
        .then(res => {
          if (res.error) {
            const msg = document.getElementById('modificaMsg');
            msg.textContent = res.error;
            msg.className = 'mb-3 alert alert-danger';
            msg.style.display = 'block';
          } else {
            bootstrap.Modal.getInstance(document.getElementById('modalModifica')).hide();
            alert('Profilo aggiornato con successo');
            location.reload();
          }
        })
        .catch(() => {
          const msg = document.getElementById('modificaMsg');
          msg.textContent = 'Errore durante la modifica del profilo.';
          msg.className = 'mb-3 alert alert-danger';
          msg.style.display = 'block';
        });
    });

    // === CAMBIO EMAIL - APRI MODAL OTP ===
    document.getElementById('btnCambiaEmail').addEventListener('click', () => {
      document.getElementById('inputNuovaEmail').value = '';
      document.getElementById('inputOtpEmail').value = '';
      document.getElementById('stepOtp').style.display = 'none';
      document.getElementById('stepNuovaEmail').style.display = 'block';
      document.getElementById('otpEmailMsg').style.display = 'none';

      const modalOtp = new bootstrap.Modal(document.getElementById('modalOtpEmail'));
      modalOtp.show();
    });

    // === INVIO OTP ALLA NUOVA EMAIL ===
    document.getElementById('btnInviaOtpEmail').addEventListener('click', () => {
      const nuovaEmail = document.getElementById('inputNuovaEmail').value.trim();
      if (!nuovaEmail) return;

      const fd = new FormData();
      fd.append('nuova_email', nuovaEmail);

      fetch('/auth/richiedi_cambio_email', {
        method: 'POST',
        body: fd
      })
        .then(r => r.json())
        .then(res => {
          const msg = document.getElementById('otpEmailMsg');
          if (res.error) {
            msg.textContent = res.error;
            msg.className = 'mb-3 alert alert-danger';
            msg.style.display = 'block';
          } else {
            msg.textContent = res.message;
            msg.className = 'mb-3 alert alert-success';
            msg.style.display = 'block';
            document.getElementById('stepNuovaEmail').style.display = 'none';
            document.getElementById('stepOtp').style.display = 'block';
          }
        })
        .catch(() => {
          const msg = document.getElementById('otpEmailMsg');
          msg.textContent = 'Errore nell\'invio del codice OTP.';
          msg.className = 'mb-3 alert alert-danger';
          msg.style.display = 'block';
        });
    });

    // === CONFERMA OTP CAMBIO EMAIL ===
    document.getElementById('btnConfermaOtpEmail').addEventListener('click', () => {
      const codice = document.getElementById('inputOtpEmail').value.trim();
      if (!codice) return;

      const fd = new FormData();
      fd.append('codice', codice);

      fetch('/auth/conferma_cambio_email', {
        method: 'POST',
        body: fd
      })
        .then(r => r.json())
        .then(res => {
          const msg = document.getElementById('otpEmailMsg');
          if (res.error) {
            msg.textContent = res.error;
            msg.className = 'mb-3 alert alert-danger';
            msg.style.display = 'block';
          } else {
            msg.textContent = res.message;
            msg.className = 'mb-3 alert alert-success';
            msg.style.display = 'block';
            // Aggiorna sessionStorage
            sessionStorage.setItem('userEmail', document.getElementById('inputNuovaEmail').value.trim());
            setTimeout(() => location.reload(), 1500);
          }
        })
        .catch(() => {
          const msg = document.getElementById('otpEmailMsg');
          msg.textContent = 'Errore nella verifica del codice.';
          msg.className = 'mb-3 alert alert-danger';
          msg.style.display = 'block';
        });
    });

    // Enter key sull'input OTP
    document.getElementById('inputOtpEmail').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('btnConfermaOtpEmail').click();
      }
    });
  </script>
  <script src="../chatbot/js/loader.js"></script>
</body>

</html>