<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Pannello Admin - Map4Aid</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .pending-card { border-left: 4px solid #ffc107; transition: transform 0.2s; }
    .pending-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="bg-light">
  <!-- Header dinamico (uguale a tutte le altre pagine) -->
  <header class="header-bg text-white p-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
      <img src="../imgs/logo.png" alt="Logo Map4Aid" width="60" height="60" class="me-3 rounded-circle">
      <h1 class="h4 mb-0 ms-3">MAP4AID</h1>
    </div>
    <div class="d-flex gap-2" id="auth-buttons"></div>
  </header>

  <div class="container mt-5">
    <div id="alertArea" class="mb-3"></div>

    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3">
        <div class="list-group">
          <a href="#" id="linkBeneficiari"
             class="list-group-item list-group-item-action active"
             onclick="mostraSezione('beneficiari'); return false;">
            Registrazioni beneficiari
            <span id="badgeBeneficiari" class="badge bg-danger float-end">0</span>
          </a>
          <a href="#" id="linkPunti"
             class="list-group-item list-group-item-action"
             onclick="mostraSezione('punti'); return false;">
            Punti distribuzione
            <span id="badgePunti" class="badge bg-danger float-end">0</span>
          </a>
        </div>
      </div>

      <!-- Contenuto principale -->
      <div class="col-md-9">

        <!-- SEZIONE BENEFICIARI -->
        <div id="sezBeneficiari">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h3 class="mb-0">Registrazioni in attesa</h3>
              <button class="btn btn-sm btn-outline-secondary" onclick="caricaBeneficiari()">Aggiorna</button>
            </div>
            <div class="card-body">
              <div id="loadingBenef" class="text-center py-3">
                <div class="spinner-border text-secondary" role="status"></div>
                <p class="mt-2 text-muted small">Caricamento...</p>
              </div>
              <div id="emptyBenef" class="alert alert-info" style="display:none;">
                Nessuna registrazione in attesa di approvazione.
              </div>
              <div id="listaBenef"></div>
              <div id="errorBenef" class="mt-3 text-danger" style="display:none;"></div>
            </div>
          </div>
        </div>

        <!-- SEZIONE PUNTI -->
        <div id="sezPunti" style="display:none;">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h3 class="mb-0">Punti distribuzione in attesa</h3>
              <button class="btn btn-sm btn-outline-secondary" onclick="caricaPunti()">Aggiorna</button>
            </div>
            <div class="card-body">
              <div id="loadingPunti" class="text-center py-3">
                <div class="spinner-border text-secondary" role="status"></div>
                <p class="mt-2 text-muted small">Caricamento...</p>
              </div>
              <div id="emptyPunti" class="alert alert-info" style="display:none;">
                Nessun punto in attesa di approvazione.
              </div>
              <div id="listaPunti"></div>
              <div id="errorPunti" class="mt-3 text-danger" style="display:none;"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-white text-center py-3 mt-4">
    <p>&copy; 2026 Map4Aid - Progetto Universitario</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    // ====== PROTEZIONE ACCESSO ======
    // 1° livello rapido: sessionStorage
    if (!isLoggedIn() || getUserRole() !== 'admin') {
      window.location.href = 'admin-login.html';
    }

    // 2° livello: verifica reale con il server
    async function verificaSessioneAdmin() {
      try {
        const res = await fetch('/auth/admin/dashboard');
        if (res.status === 403 || res.status === 401) {
          clearLoginState();
          sessionStorage.removeItem('is_admin');
          window.location.href = 'admin-login.html';
        }
      } catch (e) {
        // Errore di rete: lascia procedere
      }
    }

    // ====== UTILITA ======
    function showAlert(message, type) {
      const area = document.getElementById('alertArea');
      const div = document.createElement('div');
      div.className = `alert alert-${type} alert-dismissible fade show`;
      div.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
      area.prepend(div);
      setTimeout(() => div.remove(), 5000);
    }

    function gestisciUnauthorized(res) {
      if (res.status === 403 || res.status === 401) {
        clearLoginState();
        sessionStorage.removeItem('is_admin');
        window.location.href = 'admin-login.html';
        return true;
      }
      return false;
    }

    // ====== NAVIGAZIONE SEZIONI ======
    function mostraSezione(sezione) {
      document.getElementById('sezBeneficiari').style.display = sezione === 'beneficiari' ? '' : 'none';
      document.getElementById('sezPunti').style.display = sezione === 'punti' ? '' : 'none';
      document.getElementById('linkBeneficiari').classList.toggle('active', sezione === 'beneficiari');
      document.getElementById('linkPunti').classList.toggle('active', sezione === 'punti');
    }

    // ====== BENEFICIARI ======
    async function caricaBeneficiari() {
      const loading = document.getElementById('loadingBenef');
      const empty = document.getElementById('emptyBenef');
      const lista = document.getElementById('listaBenef');
      const errDiv = document.getElementById('errorBenef');
      const badge = document.getElementById('badgeBeneficiari');

      loading.style.display = '';
      empty.style.display = 'none';
      lista.innerHTML = '';
      errDiv.style.display = 'none';

      try {
        const res = await fetch('/auth/admin/beneficiari_pending');
        if (gestisciUnauthorized(res)) return;
        if (!res.ok) throw new Error('Errore nel caricamento');
        const data = await res.json();

        badge.textContent = data.length;
        loading.style.display = 'none';

        if (data.length === 0) { empty.style.display = ''; return; }

        lista.innerHTML = data.map(b => `
          <div class="card mb-3 pending-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="card-title mb-1">${b.nome} ${b.cognome}</h6>
                  <p class="card-text mb-1 text-muted small">${b.email}</p>
                  <p class="card-text small mb-0">Carta d'identità: <code>${b.codice_carta_identita}</code></p>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-success"
                    onclick="confermaBeneficiario(${b.id}, 'True', this)">Approva</button>
                  <button class="btn btn-sm btn-danger"
                    onclick="confermaBeneficiario(${b.id}, 'False', this)">Rifiuta</button>
                </div>
              </div>
            </div>
          </div>
        `).join('');

      } catch (err) {
        loading.style.display = 'none';
        errDiv.textContent = 'Impossibile caricare le registrazioni. Riprova più tardi.';
        errDiv.style.display = 'block';
      }
    }

    async function confermaBeneficiario(id, esito, btn) {
      const card = btn.closest('.card');
      card.style.opacity = '0.5';
      card.querySelectorAll('button').forEach(b => b.disabled = true);

      try {
        const formData = new FormData();
        formData.append('id_beneficiario', id);
        formData.append('esito', esito);

        const res = await fetch('/auth/admin/conferma_registrazione', {
          method: 'POST', body: formData
        });
        if (gestisciUnauthorized(res)) return;
        const data = await res.json();

        if (res.ok) {
          showAlert(`Registrazione ${esito === 'True' ? 'approvata' : 'rifiutata'} con successo`, 'success');
          card.remove();
          const rimanenti = document.querySelectorAll('#listaBenef .card').length;
          document.getElementById('badgeBeneficiari').textContent = rimanenti;
          if (rimanenti === 0) document.getElementById('emptyBenef').style.display = '';
        } else {
          showAlert(data.error || 'Errore durante l\'operazione', 'danger');
          card.style.opacity = '1';
          card.querySelectorAll('button').forEach(b => b.disabled = false);
        }
      } catch (err) {
        showAlert('Errore di connessione al server', 'danger');
        card.style.opacity = '1';
        card.querySelectorAll('button').forEach(b => b.disabled = false);
      }
    }

    // ====== PUNTI DISTRIBUZIONE ======
    async function caricaPunti() {
      const loading = document.getElementById('loadingPunti');
      const empty = document.getElementById('emptyPunti');
      const lista = document.getElementById('listaPunti');
      const errDiv = document.getElementById('errorPunti');
      const badge = document.getElementById('badgePunti');

      loading.style.display = '';
      empty.style.display = 'none';
      lista.innerHTML = '';
      errDiv.style.display = 'none';

      try {
        const res = await fetch('/auth/admin/punti_pending');
        if (gestisciUnauthorized(res)) return;
        if (!res.ok) throw new Error('Errore nel caricamento');
        const data = await res.json();

        badge.textContent = data.length;
        loading.style.display = 'none';

        if (data.length === 0) { empty.style.display = ''; return; }

        lista.innerHTML = data.map(p => `
          <div class="card mb-3 pending-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="card-title mb-1">${p.nome}</h6>
                  <p class="card-text mb-1 text-muted small">Ente: <strong>${p.ente}</strong></p>
                  <p class="card-text small mb-1">Giorni: ${p.giorni_apertura} &bull; Orario: ${p.orario_apertura} - ${p.orario_chiusura}</p>
                  <p class="card-text small mb-0 text-muted">Coordinate: ${p.latitudine}, ${p.longitudine}</p>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-success"
                    onclick="gestisciPunto(${p.id}, 'accetta', this)">Approva</button>
                  <button class="btn btn-sm btn-danger"
                    onclick="gestisciPunto(${p.id}, 'rifiuta', this)">Rifiuta</button>
                </div>
              </div>
            </div>
          </div>
        `).join('');

      } catch (err) {
        loading.style.display = 'none';
        errDiv.textContent = 'Impossibile caricare i punti. Riprova più tardi.';
        errDiv.style.display = 'block';
      }
    }

    async function gestisciPunto(id, azione, btn) {
      const card = btn.closest('.card');
      card.style.opacity = '0.5';
      card.querySelectorAll('button').forEach(b => b.disabled = true);

      const endpoint = azione === 'accetta'
        ? '/auth/admin/accetta_punto'
        : '/auth/admin/rifiuta_punto';

      try {
        const formData = new FormData();
        formData.append('punto_id', id);

        const res = await fetch(endpoint, { method: 'POST', body: formData });
        if (gestisciUnauthorized(res)) return;
        const data = await res.json();

        if (res.ok) {
          showAlert(`Punto ${azione === 'accetta' ? 'approvato' : 'rifiutato'} con successo`, 'success');
          card.remove();
          const rimanenti = document.querySelectorAll('#listaPunti .card').length;
          document.getElementById('badgePunti').textContent = rimanenti;
          if (rimanenti === 0) document.getElementById('emptyPunti').style.display = '';
        } else {
          showAlert(data.error || 'Errore durante l\'operazione', 'danger');
          card.style.opacity = '1';
          card.querySelectorAll('button').forEach(b => b.disabled = false);
        }
      } catch (err) {
        showAlert('Errore di connessione al server', 'danger');
        card.style.opacity = '1';
        card.querySelectorAll('button').forEach(b => b.disabled = false);
      }
    }

    // ====== INIT ======
    document.addEventListener('DOMContentLoaded', () => {
      verificaSessioneAdmin().then(() => {
        caricaBeneficiari();
        caricaPunti();
      });
    });
  </script>
</body>
</html>
